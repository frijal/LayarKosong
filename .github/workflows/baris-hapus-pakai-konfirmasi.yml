name: Remove Custom Text and Create PR (PAT Ready)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Teks/Tag yang ingin dihapus (contoh: <h3>Artikel Terkait</h3>)'
        required: true
        default: '<h3>Artikel Terkait</h3>'
      folder:
        description: 'Folder target tempat file .html berada'
        required: true
        default: 'artikel'

permissions:
  contents: write
  pull-requests: write

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.ACTIONS_PAT }}

      - name: Remove target text
        shell: bash
        run: |
          set -e
          TARGET="${{ github.event.inputs.target }}"
          FOLDER="${{ github.event.inputs.folder }}"
          
          echo "üìÇ Target folder: $FOLDER"
          echo "‚úÇÔ∏è Menghapus: $TARGET"

          if [ -d "$FOLDER" ]; then
            # Menggunakan Python untuk escape string secara literal agar aman masuk ke sed
            # Ini jauh lebih aman daripada manual sed-escape untuk karakter HTML kompleks
            ESCAPED_TARGET=$(python3 -c "import re; print(re.escape('''$TARGET'''))")
            
            echo "üîç Mencari file .html di $FOLDER..."
            
            # Cari file dan jalankan sed. 
            # Menggunakan '#' sebagai delimiter sed karena jarang ada di tag HTML biasa
            find "$FOLDER" -type f -name "*.html" -exec sed -i "s#$ESCAPED_TARGET##g" {} +
            
            echo "‚úÖ Selesai memproses file."
          else
            echo "‚ùå Folder $FOLDER tidak ditemukan!"
            exit 1
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.ACTIONS_PAT }}
          commit-message: "Clean: remove custom text from ${{ github.event.inputs.folder }}"
          branch: cleanup/remove-text
          branch-suffix: timestamp
          delete-branch: true # Menghapus branch otomatis setelah PR di-merge
          title: "Remove text from ${{ github.event.inputs.folder }}/*.html"
          body: |
            ## üßπ Content Cleanup
            Automated task untuk menghapus teks spesifik dari folder `${{ github.event.inputs.folder }}`.
            
            **Teks yang dihapus:**
            ```html
            ${{ github.event.inputs.target }}
            ```
            ---
            *Generated by [frijal-bot](https://github.com/frijal) via GitHub Actions.*
