name: ğŸ³ Docker Build & Cleanup

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Dockerfile'
      - 'package.json'
      - 'bun.lock*'
  workflow_dispatch: # Supaya bisa dijalankan manual dari tab Actions

permissions:
  contents: write # Dibutuhkan untuk menghapus package-lock.json secara otomatis

jobs:
  build-and-clean:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ambil history lengkap untuk keperluan git push

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ§¹ Clean & Sync Lockfiles
        run: |
          # 1. Hapus package-lock.json jika masih bandel ada di repo
          if [ -f package-lock.json ]; then
            echo "Nemu package-lock.json, kita sikat! ğŸ—‘ï¸"
            rm -f package-lock.json
          fi

          # 2. Re-generate bun.lock agar selalu fresh
          echo "Syncing bun.lock... ğŸ¥Ÿ"
          bun install

      - name: ğŸ› ï¸ Build Docker Image
        run: |
          # Menggunakan Docker BuildKit=0 sesuai preferensi Codespaces kamu
          # agar tetap konsisten dengan cara manual tadi
          DOCKER_BUILDKIT=0 docker build -t layarkosong-app .

      - name: ğŸš€ Auto-Commit Cleanup (Optional)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          
          # Tambahkan perubahan jika package-lock.json terhapus atau bun.lock berubah
          git add .
          
          if ! git diff --cached --quiet; then
            git commit -m "chore: cleanup lockfiles and sync bun.lock ğŸ§¹"
            git push origin main
          else
            echo "Semua sudah bersih, tidak ada yang perlu di-commit."
          fi
