name: ๐ Pengecekan & Laporan Konten Harian
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  maintenance_and_reporting:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Cache Node Modules
        uses: actions/cache@v5.0.1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: 2. Setup Node.js & Python
        uses: actions/setup-node@v6.1.0
        with:
          node-version: '24'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 3. Cleanup Orphan .webp Images (Manual Logic)
        run: |
          echo "๐งน Membersihkan gambar orphan (.webp)..."
          for file in img/*.webp; do
            [ -e "$file" ] || continue
            slug="${file##*/}"
            slug="${slug%.webp}"
            if [ ! -f "artikel/${slug}.html" ]; then
              git rm -f "$file"
            fi
          done

      # --- TAMBAHAN STEP UNTUK SCRIPT PYTHON ---
      
      - name: 3.1 Jalankan Script Scan Gambar Nganggur
        run: |
          echo "๐ Menjalankan cek_gambar.py..."
          python3 ext/cek_gambar.py
          
      - name: 3.2 Hapus Gambar Berdasarkan Daftar Nganggur
        run: |
          LIST_FILE="img/gambarnganggur.txt"
          if [ -f "$LIST_FILE" ]; then
            echo "๐ Membaca daftar dari $LIST_FILE..."
            while IFS= read -r filename; do
              # Abaikan jika baris kosong atau pesan "Semua gambar terpakai"
              if [[ -n "$filename" && "$filename" == *.webp ]]; then
                TARGET="img/$filename"
                if [ -f "$TARGET" ]; then
                  echo "-> Menghapus berdasarkan daftar: $TARGET"
                  git rm -f "$TARGET"
                fi
              fi
            done < "$LIST_FILE"
          fi

      # -----------------------------------------

      - name: 4. Buat Laporan Markdown Detail per Folder/Subfolder
ย ย ย ย id: counts
ย ย ย ย run: |
ย ย ย ย ย echo "๐ Membuat laporan markdown dengan folder/subfolder dan emoji & histogram global..."
ย ย ย ย ย DATE=$(date +'%Y-%m-%d')
ย ย ย ย ย REPORT_PATH="mini/${DATE}-laporan_konten.md"

ย ย ย ย ย FOLDERS=("artikel" "img" "ext")
ย ย ย ย ย MAX_BLOCKS=20

ย ย ย ย ย declare -A ext_emoji=(
ย ย ย ย ย ย [css]="๐จ"
ย ย ย ย ย ย [html]="๐"
ย ย ย ย ย ย [ico]="๐"
ย ย ย ย ย ย [jpeg]="๐ผ๏ธ"
ย ย ย ย ย ย [jpg]="๐ผ๏ธ"
ย ย ย ย ย ย [js]="๐"
ย ย ย ย ย ย [json]="๐๏ธ"
ย ย ย ย ย ย [pl]="๐"
ย ย ย ย ย ย [png]="๐ผ๏ธ"
ย ย ย ย ย ย [py]="๐"
ย ย ย ย ย ย [sh]="๐ป"
ย ย ย ย ย ย [svg]="โ๏ธ"
ย ย ย ย ย ย [txt]="๐"
ย ย ย ย ย ย [webp]="๐ผ๏ธ"
ย ย ย ย ย )

ย ย ย ย ย declare -A global_ext_count
ย ย ย ย ย declare -A global_ext_folders
ย ย ย ย ย max_global_count=0

ย ย ย ย ย # Hitung global ekstensi dan folder path tiap file
ย ย ย ย ย for folder in "${FOLDERS[@]}"; do
ย ย ย ย ย ย while IFS= read -r file; do
ย ย ย ย ย ย ย ext="${file##*.}"
ย ย ย ย ย ย ย global_ext_count[$ext]=$(( ${global_ext_count[$ext]:-0} + 1 ))
ย ย ย ย ย ย ย dir_path=$(dirname "$file")
ย ย ย ย ย ย ย global_ext_folders[$ext]+="${dir_path} "
ย ย ย ย ย ย done < <(find "$folder" -maxdepth 5 -type f 2>/dev/null)
ย ย ย ย ย done

ย ย ย ย ย for c in "${global_ext_count[@]}"; do
ย ย ย ย ย ย [ $c -gt $max_global_count ] && max_global_count=$c
ย ย ย ย ย done
ย ย ย ย ย [ $max_global_count -eq 0 ] && max_global_count=1

ย ย ย ย ย {
ย ย ย ย ย ย echo "# Laporan Konten Harian ($DATE)"
ย ย ย ย ย ย echo ""
ย ย ย ย ย ย total_global=0

ย ย ย ย ย ย # Laporan per folder/subfolder
ย ย ย ย ย ย for folder in "${FOLDERS[@]}"; do
ย ย ย ย ย ย ย # List semua subfolder
ย ย ย ย ย ย ย mapfile -t subfolders < <(find "$folder" -maxdepth 5 -type d 2>/dev/null)
ย ย ย ย ย ย ย for subfolder in "${subfolders[@]}"; do
ย ย ย ย ย ย ย ย # Hitung file per ekstensi
ย ย ย ย ย ย ย ย declare -A subfolder_ext_count
ย ย ย ย ย ย ย ย while IFS= read -r file; do
ย ย ย ย ย ย ย ย ย ext="${file##*.}"
ย ย ย ย ย ย ย ย ย subfolder_ext_count[$ext]=$(( ${subfolder_ext_count[$ext]:-0} + 1 ))
ย ย ย ย ย ย ย ย done < <(find "$subfolder" -maxdepth 1 -type f 2>/dev/null)

ย ย ย ย ย ย ย ย [ ${#subfolder_ext_count[@]} -eq 0 ] && continue

ย ย ย ย ย ย ย ย echo "## Folder/Subfolder: $subfolder"
ย ย ย ย ย ย ย ย echo ""
ย ย ย ย ย ย ย ย echo "| Jenis File | Jumlah | Histogram |"
ย ย ย ย ย ย ย ย echo "|-----------:|-------:|-----------|"

ย ย ย ย ย ย ย ย for ext in $(printf "%s\n" "${!subfolder_ext_count[@]}" | sort); do
ย ย ย ย ย ย ย ย ย count=${subfolder_ext_count[$ext]}
ย ย ย ย ย ย ย ย ย total_global=$((total_global + count))
ย ย ย ย ย ย ย ย ย blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
ย ย ย ย ย ย ย ย ย histogram=$(printf 'โ%.0s' $(seq 1 $blocks))
ย ย ย ย ย ย ย ย ย emoji=${ext_emoji[$ext]:-๐}
ย ย ย ย ย ย ย ย ย printf "| %s %-8s | %6d | %s |\n" "$emoji" "$ext" "$count" "$histogram"
ย ย ย ย ย ย ย ย done

ย ย ย ย ย ย ย ย echo ""
ย ย ย ย ย ย ย ย unset subfolder_ext_count
ย ย ย ย ย ย ย done
ย ย ย ย ย ย done

ย ย ย ย ย ย # Ringkasan global
ย ย ย ย ย ย echo "## Ringkasan Global (semua folder)"
ย ย ย ย ย ย echo ""
ย ย ย ย ย ย echo "| Jenis File | Jumlah | Histogram | Folder/Subfolder (unik) |"
ย ย ย ย ย ย echo "|-----------:|-------:|-----------|-----------------|"
ย ย ย ย ย ย for ext in $(printf "%s\n" "${!global_ext_count[@]}" | sort); do
ย ย ย ย ย ย ย count=${global_ext_count[$ext]}
ย ย ย ย ย ย ย blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
ย ย ย ย ย ย ย histogram=$(printf 'โ%.0s' $(seq 1 $blocks))
ย ย ย ย ย ย ย emoji=${ext_emoji[$ext]:-๐}
ย ย ย ย ย ย ย folder_unique=$(echo "${global_ext_folders[$ext]}" | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
ย ย ย ย ย ย ย printf "| %s %-8s | %6d | %s | %s |\n" "$emoji" "$ext" "$count" "$histogram" "$folder_unique"
ย ย ย ย ย ย done

ย ย ย ย ย ย printf "| **TOTAL** | %6d | | |\n" "$total_global"

ย ย ย ย ย } > "$REPORT_PATH"

ย ย ย ย ย cat "$REPORT_PATH"

      - name: 5. Rotasi Laporan Lama 
        run: |
          files=(mini/*-laporan_konten.md)
          if [ ${#files[@]} -gt 7 ]; then
            echo "๐๏ธ Menghapus laporan lama..."
            rm -f "${files[@]:7}"
          fi
          
      - name: 6. Commit Semua Perubahan Sekaligus
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # Tambahkan semua folder yang terlibat
          git add img/ mini/ ext/
          
          if ! git diff --staged --quiet; then
            echo "๐ Perubahan ditemukan, membuat commit..."
            git commit -m "chore: Daily maintenance (cleanup via python, report)" \
            --author="frijal <5477182+frijal@users.noreply.github.com>"
            git pull origin main --rebase
            git push
          else
            echo "โ Tidak ada perubahan baru untuk di-commit."
          fi
