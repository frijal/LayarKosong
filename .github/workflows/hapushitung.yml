name: ğŸ”† Pengecekan & Laporan Konten Harian
on:
  schedule:
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  maintenance_and_reporting:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 3. Cleanup Orphan .webp Images
        id: cleanup_step
        run: |
          echo "ğŸ§¹ Membersihkan gambar orphan (.webp)..."
          DELETED_COUNT=0
          mkdir -p img
          for file in img/*.webp; do
            [ -e "$file" ] || continue
            slug="${file##*/}"
            slug="${slug%.webp}"
            if [ ! -f "artikel/${slug}.html" ]; then
              echo "-> Orphan ditemukan: $file, menghapus..."
              git rm -f "$file"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ§¹ Total orphan .webp dihapus: $DELETED_COUNT"

      - name: 4. Buat Laporan Markdown Detail per Folder/Subfolder
        id: counts
        run: |
          echo "ğŸ“Š Membuat laporan markdown dengan folder/subfolder dan emoji & histogram global..."
          DATE=$(date +'%m-%d-%yyyy')
          REPORT_PATH="mini/${DATE}-laporan_konten.md"
          mkdir -p mini

          FOLDERS=("artikel" "img" "ext" "api")
          MAX_BLOCKS=20

          declare -A ext_emoji=(
            [html]="ğŸŒ"
            [webp]="ğŸ–¼ï¸"
            [png]="ğŸ–¼ï¸"
            [jpg]="ğŸ–¼ï¸"
            [jpeg]="ğŸ–¼ï¸"
            [txt]="ğŸ“„"
            [sh]="ğŸ’»"
            [js]="ğŸ“œ"
            [css]="ğŸ¨"
            [json]="ğŸ—‚ï¸"
            [svg]="âœï¸"
            [py]="ğŸ"
            [pl]="ğŸ“Œ"
            [ico]="ğŸ”‘"
          )

          declare -A global_ext_count
          declare -A global_ext_folders
          max_global_count=0

          # Hitung global ekstensi dan folder path tiap file
          for folder in "${FOLDERS[@]}"; do
            while IFS= read -r file; do
              ext="${file##*.}"
              global_ext_count[$ext]=$(( ${global_ext_count[$ext]:-0} + 1 ))
              dir_path=$(dirname "$file")
              global_ext_folders[$ext]+="${dir_path} "
            done < <(find "$folder" -maxdepth 5 -type f 2>/dev/null)
          done

          for c in "${global_ext_count[@]}"; do
            [ $c -gt $max_global_count ] && max_global_count=$c
          done
          [ $max_global_count -eq 0 ] && max_global_count=1

          {
            echo "# Laporan Konten Harian ($DATE)"
            echo ""
            total_global=0

            # Laporan per folder/subfolder
            for folder in "${FOLDERS[@]}"; do
              # List semua subfolder
              mapfile -t subfolders < <(find "$folder" -maxdepth 5 -type d 2>/dev/null)
              for subfolder in "${subfolders[@]}"; do
                # Hitung file per ekstensi
                declare -A subfolder_ext_count
                while IFS= read -r file; do
                  ext="${file##*.}"
                  subfolder_ext_count[$ext]=$(( ${subfolder_ext_count[$ext]:-0} + 1 ))
                done < <(find "$subfolder" -maxdepth 1 -type f 2>/dev/null)

                [ ${#subfolder_ext_count[@]} -eq 0 ] && continue

                echo "## Folder/Subfolder: $subfolder"
                echo ""
                echo "| Jenis File | Jumlah | Histogram |"
                echo "|-----------:|-------:|-----------|"

                for ext in $(printf "%s\n" "${!subfolder_ext_count[@]}" | sort); do
                  count=${subfolder_ext_count[$ext]}
                  total_global=$((total_global + count))
                  blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
                  histogram=$(printf 'â–‡%.0s' $(seq 1 $blocks))
                  emoji=${ext_emoji[$ext]:-ğŸ“}
                  printf "| %s %-8s | %6d | %s |\n" "$emoji" "$ext" "$count" "$histogram"
                done

                echo ""
                unset subfolder_ext_count
              done
            done

            # Ringkasan global
            echo "## Ringkasan Global (semua folder)"
            echo ""
            echo "| Jenis File | Jumlah | Histogram | Folder/Subfolder (unik) |"
            echo "|-----------:|-------:|-----------|-----------------|"
            for ext in $(printf "%s\n" "${!global_ext_count[@]}" | sort); do
              count=${global_ext_count[$ext]}
              blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
              histogram=$(printf 'â–‡%.0s' $(seq 1 $blocks))
              emoji=${ext_emoji[$ext]:-ğŸ“}
              folder_unique=$(echo "${global_ext_folders[$ext]}" | tr ' ' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
              printf "| %s %-8s | %6d | %s | %s |\n" "$emoji" "$ext" "$count" "$histogram" "$folder_unique"
            done

            printf "| **TOTAL** | %6d | | |\n" "$total_global"

          } > "$REPORT_PATH"

          cat "$REPORT_PATH"

      - name: 5. Rotasi Laporan Lama 
        run: |
         files=(mini/*-laporan_konten.md)
         if [ ${#files[@]} -gt 7 ]; then
         echo "ğŸ—‘ï¸ Menghapus laporan lama..."
         rm -f "${files[@]:7}"
         fi
         
      - name: 6. Commit Semua Perubahan Sekaligus
        run: |
         git config --global user.name 'github-actions[bot]'
         git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
         git add img/ mini/ ext/ api/
         if ! git diff --staged --quiet; then
         echo "ğŸ“ Perubahan ditemukan, membuat commit..."
         git commit -m "chore: Daily maintenance (screenshots, cleanup, report)" \
         --author="frijal <5477182+frijal@users.noreply.github.com>"
         git pull origin main --rebase
         git push
         else
         echo "âœ… Tidak ada perubahan baru untuk di-commit."
         fi
