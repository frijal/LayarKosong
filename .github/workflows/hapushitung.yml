name: ğŸ”† Pengecekan & Laporan Konten Harian

on:
  schedule:
    - cron: '0 11 * * *' # Jam 11 UTC / 19:00 WITA
  workflow_dispatch: # Bisa dijalankan manual dari tab Actions

jobs:
  maintenance_and_reporting:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ========== SETUP ENVIRONMENT ==========
      - name: 1. Checkout Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0 # Ambil history lengkap untuk keperluan push & rebase
          persist-credentials: true

      - name: ğŸš€ Setup Bun.js
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: ğŸ“‚ Cache Bun Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-cache-static
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: ğŸ› ï¸ Maintenance & Update
        run: |
          bun upgrade
          bun update
          bun install --no-progress

      # ========== AUTOMATION SCRIPTS ==========
      - name: ğŸ•µï¸ Update Dashboard Jadwal
        run: bun run ext/workflow-list.js || echo "Script dashboard tidak ditemukan, skip."

      - name: ğŸ“¸ Scan Unused Images
        run: |
          echo "ğŸ” Menjalankan pengecekan gambar..."
          bun run ext/cek-gambar.js || echo "Script cek-gambar tidak ditemukan, skip."

      # ========== CONTENT REPORT GENERATION (ANTI-ERROR V7.0) ==========
      - name: ğŸ“Š Generate Detailed Content Report
        id: generate_report
        run: |
          echo "ğŸ“Š Membuat laporan markdown dinamis V6.9 (Auto-detect Categories)..."
          
          DATE=$(date +'%Y-%m-%d')
          # Simpan DATE ke environment agar bisa dipakai di step commit
          echo "DATE=$DATE" >> $GITHUB_ENV
          mkdir -p mini
          REPORT_PATH="mini/${DATE}-laporan_konten.md"
          MAX_BLOCKS=20

          # Fungsi Escape Markdown agar karakter # tidak merusak tabel
          escape_md() {
            echo "$1" | sed 's/[_#*`\[\]]/\\&/g'
          }

          # --- DETEKSI FOLDER DINAMIS (Anti-Error) ---
          SKIP_PATTERN="^\./(\.git|\.github|node_modules|mini)$"
          # Simpan daftar folder ke file temp untuk menghindari masalah subshell
          find . -maxdepth 2 -type d -not -path '*/.*' | grep -vE "$SKIP_PATTERN" | sed 's|^\./||' | sort -u > folders_list.txt

          declare -A ext_emoji=(
            [css]="ğŸ¨" [html]="ğŸŒ" [ico]="ğŸ”‘" [jpeg]="ğŸ–¼ï¸" [jpg]="ğŸ–¼ï¸" 
            [js]="ğŸ“œ" [json]="ğŸ—‚ï¸" [png]="ğŸ–¼ï¸" [py]="ğŸ" [sh]="ğŸ’»" 
            [svg]="âœï¸" [txt]="ğŸ“„" [webp]="ğŸ–¼ï¸" [md]="ğŸ“" [no-ext]="â“"
          )

          # Inisialisasi variabel global
          total_global=0
          declare -A global_ext_count
          declare -A global_ext_folders
          max_global_count=0

          # 1. Collect global statistics (Pre-scan)
          while read -r folder; do
            [[ -z "$folder" || "$folder" == "." ]] && continue
            while IFS= read -r -d $'\0' file; do
              ext="${file##*.}"
              [[ "$file" != *.* ]] && ext="no-ext"
              global_ext_count["$ext"]=$(( ${global_ext_count["$ext"]:-0} + 1 ))
              
              dir_name=$(dirname "$file")
              if [[ ! "${global_ext_folders["$ext"]}" =~ "$dir_name" ]]; then
                global_ext_folders["$ext"]+="$dir_name | "
              fi
            done < <(find "$folder" -maxdepth 5 -type f -print0 2>/dev/null)
          done < folders_list.txt

          # Hitung max untuk histogram
          for count in "${global_ext_count[@]}"; do
            (( count > max_global_count )) && max_global_count=$count
          done
          (( max_global_count == 0 )) && max_global_count=1

          # 2. Mulai Menulis Laporan (Line by line agar tidak kosong)
          {
            echo "# ğŸ”† Laporan Konten Harian Layar Kosong"
            echo "Dihasilkan pada: $(date '+%d %B %Y %H:%M:%S') Balikpapan Time"
            echo ""

            # Analisis Per Folder
            while read -r folder; do
              [[ -z "$folder" || "$folder" == "." ]] && continue
              
              # Subfolder scan
              find "$folder" -maxdepth 2 -type d -print0 2>/dev/null | while IFS= read -r -d $'\0' subfolder; do
                declare -A subf_count
                has_files=false
                
                while IFS= read -r -d $'\0' file; do
                  ext="${file##*.}"
                  [[ "$file" != *.* ]] && ext="no-ext"
                  subf_count["$ext"]=$(( ${subf_count["$ext"]:-0} + 1 ))
                  has_files=true
                done < <(find "$subfolder" -maxdepth 1 -type f -print0 2>/dev/null)

                if [ "$has_files" = true ]; then
                  safe_name=$(escape_md "$subfolder")
                  echo "### ğŸ“‚ Folder: $safe_name"
                  echo ""
                  echo "| Jenis File | Jumlah | Histogram |"
                  echo "|:-----------|-------:|:----------|"

                  for ext in $(printf "%s\n" "${!subf_count[@]}" | sort); do
                    count=${subf_count["$ext"]}
                    total_global=$(( total_global + count ))
                    blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
                    [[ $blocks -gt $MAX_BLOCKS ]] && blocks=$MAX_BLOCKS
                    histogram=$(printf 'â–‡%.0s' $(seq 1 "$blocks" 2>/dev/null || echo 1))
                    emoji=${ext_emoji["$ext"]:-ğŸ“„}
                    printf "| %s %-8s | %6d | %s |\n" "$emoji" "$ext" "$count" "$histogram"
                  done
                  echo ""
                fi
              done
            done < folders_list.txt

            # Ringkasan Global
            echo "---"
            echo "## ğŸ“Š Ringkasan Statistik Global"
            echo ""
            echo "| Ekstensi | Total | Histogram | Lokasi |"
            echo "|:---------|------:|:----------|:-------|"

            for ext in $(printf "%s\n" "${!global_ext_count[@]}" | sort); do
              count=${global_ext_count["$ext"]}
              blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
              histogram=$(printf 'â–‡%.0s' $(seq 1 "$blocks" 2>/dev/null || echo 1))
              emoji=${ext_emoji["$ext"]:-ğŸ“„}
              safe_locs=$(escape_md "${global_ext_folders["$ext"]% | }")
              printf "| %s %-8s | %6d | %s | %s |\n" "$emoji" "$ext" "$count" "$histogram" "$safe_locs"
            done
            echo "| **TOTAL** | **$total_global** | | |"
          } > "$REPORT_PATH"

          echo "âœ… Laporan V6.9 sukses: $REPORT_PATH"

      # ========== REPORT ROTATION ==========
      - name: ğŸ§¹ Rotasi Laporan Lama (Keep Last 7)
        run: |
          files=(mini/*-laporan_konten.md)
          if [ ${#files[@]} -gt 7 ]; then
            echo "ğŸ—‘ï¸ Menghapus laporan lama..."
            sorted_files=($(printf '%s\n' "${files[@]}" | sort))
            files_to_delete=("${sorted_files[@]:0:${#sorted_files[@]}-7}")
            for file in "${files_to_delete[@]}"; do
              rm -f "$file"
            done
          fi

      # ========== COMMIT & PUSH ==========
      - name: ğŸ“® Commit & Push All Changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Perubahan ditemukan, melakukan commit..."
            
            git config --global user.name 'github-actions[bot]'
            git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
            
            git add .
            
            DATE=${{ env.REPORT_DATE }}
            added_count=$(git diff --staged --name-status | grep -c "^A" || true)
            deleted_count=$(git diff --staged --name-status | grep -c "^D" || true)
            
            # [skip ci] sangat penting untuk mencegah infinite loop!
            git commit -m "chore: Daily maintenance report ($DATE) ğŸ“Š [skip ci]

            - Added: $added_count file(s)
            - Deleted: $deleted_count file(s)
            - Report: ${DATE}-laporan_konten.md" \
            --author="frijal <5477182+frijal@users.noreply.github.com>"
            
            git pull origin main --rebase --strategy-option=theirs
            git push origin main
            echo "âœ… Sukses di-push ke main!"
          else
            echo "âœ… Tidak ada perubahan yang perlu di-commit."
          fi
