name: ğŸ”† Pengecekan & Laporan Konten Harian
on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  maintenance_and_reporting:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ========== SETUP ENVIRONMENT ==========
      - name: 1. Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: '2. Setup Bun.js'
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest
          
      - name: ğŸ› ï¸ Maintenance & Update
        run: |
          bun upgrade
          bun update
          bun install --no-progress
    
      # ========== IMAGE CLEANUP ==========     
      - name: ğŸ•µï¸ Update Dashboard Jadwal
        run: bun run ext/workflow-list.js
      
      - name: 3. Scan Unused Images via Python
        id: Bun_scan
        run: |
          echo "ğŸ Menjalankan cek_gambar.py..."
          bun run ext/cek-gambar.js
          
      # ========== CONTENT REPORT GENERATION ==========
      - name: 5. Generate Detailed Content Report
        id: generate_report
        run: |
          echo "ğŸ“Š Membuat laporan markdown dinamis V6.9 (Auto-detect Categories)..."

          DATE=$(date +'%Y-%m-%d')
          REPORT_PATH="mini/${DATE}-laporan_konten.md"
          MAX_BLOCKS=20

          # === DETEKSI FOLDER DINAMIS ===
          # Mencari semua folder di root, tapi abaikan folder sistem GitHub & Node
          SKIP_PATTERN="^\./(\.git|\.github|node_modules|mini)$"
          # Ambil folder yang berisi file .html (ini pasti folder kategori) + folder wajib
          MAP_FOLDERS=($(find . -maxdepth 2 -type d | grep -vE "$SKIP_PATTERN" | sed 's|^\./||' | sort -u))
          
          echo "ğŸ“‚ Folder yang dipantau: ${MAP_FOLDERS[*]}"

          # Emoji mapping
          declare -A ext_emoji=(
            [css]="ğŸ¨" [html]="ğŸŒ" [ico]="ğŸ”‘" [jpeg]="ğŸ–¼ï¸" [jpg]="ğŸ–¼ï¸" 
            [js]="ğŸ“œ" [json]="ğŸ—‚ï¸" [png]="ğŸ–¼ï¸" [py]="ğŸ" [sh]="ğŸ’»" 
            [svg]="âœï¸" [txt]="ğŸ“„" [webp]="ğŸ–¼ï¸" [md]="ğŸ“"
          )

          declare -A global_ext_count
          declare -A global_ext_folders
          max_global_count=0

          # 1. Collect global statistics
          for folder in "${MAP_FOLDERS[@]}"; do
            [ -d "$folder" ] || continue
            while IFS= read -r file; do
              ext="${file##*.}"
              global_ext_count[$ext]=$(( ${global_ext_count[$ext]:-0} + 1 ))
              dir_path=$(dirname "$file")
              global_ext_folders[$ext]+="${dir_path} "
            done < <(find "$folder" -maxdepth 5 -type f 2>/dev/null || true)
          done

          # Find max count for histogram scaling
          for c in "${global_ext_count[@]}"; do
            (( c > max_global_count )) && max_global_count=$c
          done
          (( max_global_count == 0 )) && max_global_count=1

          # 2. Generate report
          {
            echo "# ğŸ”† Laporan Konten Harian Layar Kosong"
            echo "Dihasilkan pada: $(date '+%d %B %Y %H:%M:%S') Balikpapan Time"
            echo ""

            total_global=0

            # 3. Per-folder analysis (Iterasi Folder Kategori)
            for folder in "${MAP_FOLDERS[@]}"; do
              [ -d "$folder" ] || continue
              
              # Subfolder scan (untuk kategori yang punya sub-kategori)
              mapfile -t subfolders < <(find "$folder" -maxdepth 2 -type d 2>/dev/null || true)

              for subfolder in "${subfolders[@]}"; do
                declare -A subf_count
                while IFS= read -r file; do
                  ext="${file##*.}"
                  subf_count[$ext]=$(( ${subf_count[$ext]:-0} + 1 ))
                done < <(find "$subfolder" -maxdepth 1 -type f 2>/dev/null || true)

                (( ${#subf_count[@]} == 0 )) && continue

                echo "### ğŸ“‚ Folder: $subfolder"
                echo ""
                echo "| Jenis File | Jumlah | Histogram |"
                echo "|:-----------|-------:|:----------|"

                for ext in $(printf "%s\n" "${!subf_count[@]}" | sort); do
                  count=${subf_count[$ext]}
                  total_global=$(( total_global + count ))
                  
                  blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
                  [ $blocks -gt $MAX_BLOCKS ] && blocks=$MAX_BLOCKS
                  histogram=$(printf 'â–‡%.0s' $(seq 1 "$blocks" 2>/dev/null || echo 1))
                  emoji=${ext_emoji[$ext]:-ğŸ“„}

                  printf "| %s %-8s | %6d | %s |\n" "$emoji" "$ext" "$count" "$histogram"
                done
                echo ""
                unset subf_count
              done
            done

            # 4. Global summary
            echo "---"
            echo "## ğŸ“Š Ringkasan Statistik Global"
            echo ""
            echo "| Ekstensi | Total | Histogram | Lokasi |"
            echo "|:---------|------:|:----------|:-------|"

            for ext in $(printf "%s\n" "${!global_ext_count[@]}" | sort); do
              count=${global_ext_count[$ext]}
              blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
              [ $blocks -gt $MAX_BLOCKS ] && blocks=$MAX_BLOCKS
              histogram=$(printf 'â–‡%.0s' $(seq 1 "$blocks" 2>/dev/null || echo 1))
              emoji=${ext_emoji[$ext]:-ğŸ“„}

              # Merapikan list folder unik
              folder_unique=$(echo "${global_ext_folders[$ext]}" | tr ' ' '\n' | grep -v "^$" | sort -u | tr '\n' ',' | sed 's/,$//; s/,/, /g')

              printf "| %s %-8s | %6d | %s | %s |\n" "$emoji" "$ext" "$count" "$histogram" "$folder_unique"
            done
            echo "| **TOTAL** | **$total_global** | | |"

          } > "$REPORT_PATH"

          echo "âœ… Laporan V6.9 sukses: $REPORT_PATH"

      # ========== REPORT ROTATION ==========
      - name: 6. Rotasi Laporan Lama (Keep Last 7)
        id: rotate_reports
        run: |
          files=(mini/*-laporan_konten.md)
          if [ ${#files[@]} -gt 7 ]; then
            echo "ğŸ—‘ï¸ Menghapus laporan lama..."
            # Sort by date in filename
            sorted_files=($(printf '%s\n' "${files[@]}" | sort))
            files_to_delete=("${sorted_files[@]:0:${#sorted_files[@]}-7}")
            
            for file in "${files_to_delete[@]}"; do
              echo "â†’ Menghapus: $file"
              rm -f "$file"
            done
            echo "Total dihapus: ${#files_to_delete[@]} file"
          else
            echo "â„¹ï¸  Tidak ada laporan yang perlu dihapus (${#files[@]}/7)"
          fi

    #  - name: ğŸ” Run Ultimate Global Audit
    #    run: |
    #      python3 mini/periksa-unused.py

      # ========== COMMIT CHANGES ==========
      - name: 7. Commit & Push All Changes
        id: commit_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
          # Configure Git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # Add all modified directories
          git add .
          fi
          # Check for changes
          if ! git diff --staged --quiet; then
            echo "ğŸ“ Perubahan ditemukan, membuat commit..."
            
            # Get changes summary
            added_count=$(git diff --staged --name-status | grep -c "^A" || true)
            deleted_count=$(git diff --staged --name-status | grep -c "^D" || true)
            
            git commit -m "chore: Daily maintenance report ($DATE) ğŸ“Š
            
            - Added: $added_count file(s)
            - Deleted: $deleted_count file(s)
            - Report: ${DATE}-laporan_konten.md" \
              --author="frijal <5477182+frijal@users.noreply.github.com>"
            
            # Pull latest changes and push
            git pull origin main --rebase --strategy-option=theirs
            git push origin main
            
            echo "âœ… Perubahan berhasil di-commit dan di-push"
          else
            echo "âœ… Tidak ada perubahan baru untuk di-commit."
          fi
