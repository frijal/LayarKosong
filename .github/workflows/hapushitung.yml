name: üîÜ Pengecekan & Laporan Konten Harian
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  maintenance_and_reporting:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ========== SETUP ENVIRONMENT ==========
      - name: 1. Checkout Repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: 2. Setup Node.js & Python
        uses: actions/setup-node@v6.1.0
        with:
          node-version: '24'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Cache Node Modules
        uses: actions/cache@v5.0.1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ========== IMAGE CLEANUP ==========     
      - name: 3. Scan Unused Images via Python
        id: python_scan
        run: |
          echo "üêç Menjalankan cek_gambar.py..."
          python3 ext/cek_gambar.py
          
          LIST_FILE="img/gambarnganggur.txt"
          if [ -f "$LIST_FILE" ]; then
            echo "üìë Membaca daftar dari $LIST_FILE..."
            cleaned_py_count=0
            while IFS= read -r filename; do
              if [[ -n "$filename" && "$filename" == *.webp ]]; then
                TARGET="img/$filename"
                if [ -f "$TARGET" ]; then
                  echo "‚Üí Menghapus (dari daftar Python): $TARGET"
                  git rm -f "$TARGET"
                  cleaned_py_count=$((cleaned_py_count + 1))
                fi
              elif [[ -n "$filename" && "$filename" != "Semua gambar terpakai" ]]; then
                echo "‚ö†Ô∏è  Baris tidak diproses: $filename"
              fi
            done < "$LIST_FILE"
            echo "Jumlah yang dihapus (Python): $cleaned_py_count"
          else
            echo "‚ÑπÔ∏è  File daftar tidak ditemukan: $LIST_FILE"
          fi

      - name: 4. Cleanup Orphan .webp Images (Manual)
        id: manual_cleanup
        run: |
          echo "üßπ Membersihkan gambar orphan (.webp)..."
          cleaned_count=0
          for file in img/*.webp; do
            [ -e "$file" ] || continue
            slug="${file##*/}"
            slug="${slug%.webp}"
            if [ ! -f "artikel/${slug}.html" ]; then
              echo "‚Üí Menghapus: $file"
              git rm -f "$file"
              cleaned_count=$((cleaned_count + 1))
            fi
          done
          echo "Jumlah yang dihapus (manual): $cleaned_count"
          
      # ========== CONTENT REPORT GENERATION ==========
      - name: 5. Generate Detailed Content Report
        id: generate_report
        run: |
          echo "üìä Membuat laporan markdown dengan folder/subfolder dan emoji & histogram global..."

          DATE=$(date +'%Y-%m-%d')
          REPORT_PATH="mini/${DATE}-laporan_konten.md"
          FOLDERS=("artikel" "img" "ext")
          MAX_BLOCKS=20

          # Emoji mapping
          declare -A ext_emoji=(
            [css]="üé®"
            [html]="üåê"
            [ico]="üîë"
            [jpeg]="üñºÔ∏è"
            [jpg]="üñºÔ∏è"
            [js]="üìú"
            [json]="üóÇÔ∏è"
            [pl]="üìå"
            [png]="üñºÔ∏è"
            [py]="üêç"
            [sh]="üíª"
            [svg]="‚úèÔ∏è"
            [txt]="üìÑ"
            [webp]="üñºÔ∏è"
          )

          # Global counters
          declare -A global_ext_count
          declare -A global_ext_folders
          max_global_count=0

          # 1. Collect global statistics
          echo "Mengumpulkan statistik global..."
          for folder in "${FOLDERS[@]}"; do
            while IFS= read -r file; do
              ext="${file##*.}"
              global_ext_count[$ext]=$(( ${global_ext_count[$ext]:-0} + 1 ))
              dir_path=$(dirname "$file")
              global_ext_folders[$ext]+="${dir_path} "
            done < <(find "$folder" -maxdepth 5 -type f 2>/dev/null || true)
          done

          # Find max count for histogram scaling
          for c in "${global_ext_count[@]}"; do
            (( c > max_global_count )) && max_global_count=$c
          done
          (( max_global_count == 0 )) && max_global_count=1

          # 2. Generate report
          {
            echo "# Laporan Konten Harian ($DATE)"
            echo ""

            total_global=0

            # 3. Per-folder analysis
            for folder in "${FOLDERS[@]}"; do
              mapfile -t subfolders < <(find "$folder" -maxdepth 5 -type d 2>/dev/null || true)

              for subfolder in "${subfolders[@]}"; do
                declare -A subfolder_ext_count

                while IFS= read -r file; do
                  ext="${file##*.}"
                  subfolder_ext_count[$ext]=$(( ${subfolder_ext_count[$ext]:-0} + 1 ))
                done < <(find "$subfolder" -maxdepth 1 -type f 2>/dev/null || true)

                (( ${#subfolder_ext_count[@]} == 0 )) && continue

                echo "## Folder/Subfolder: $subfolder"
                echo ""
                echo "| Jenis File | Jumlah | Histogram |"
                echo "|-----------:|-------:|-----------|"

                for ext in $(printf "%s\n" "${!subfolder_ext_count[@]}" | sort); do
                  count=${subfolder_ext_count[$ext]}
                  total_global=$(( total_global + count ))

                  blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
                  blocks=$(( blocks > MAX_BLOCKS ? MAX_BLOCKS : blocks ))
                  histogram=$(printf '‚ñá%.0s' $(seq 1 "$blocks"))
                  emoji=${ext_emoji[$ext]:-üìÅ}

                  printf "| %s %-8s | %6d | %s |\n" \
                    "$emoji" "$ext" "$count" "$histogram"
                done

                echo ""
                unset subfolder_ext_count
              done
            done

            # 4. Global summary
            echo "## Ringkasan Global (semua folder)"
            echo ""
            echo "| Jenis File | Jumlah | Histogram | Folder/Subfolder (unik) |"
            echo "|-----------:|-------:|-----------|-------------------------|"

            for ext in $(printf "%s\n" "${!global_ext_count[@]}" | sort); do
              count=${global_ext_count[$ext]}
              blocks=$(( (count * MAX_BLOCKS + max_global_count - 1) / max_global_count ))
              blocks=$(( blocks > MAX_BLOCKS ? MAX_BLOCKS : blocks ))
              histogram=$(printf '‚ñá%.0s' $(seq 1 "$blocks"))
              emoji=${ext_emoji[$ext]:-üìÅ}

              folder_unique=$(
                echo "${global_ext_folders[$ext]}" \
                | tr ' ' '\n' \
                | sort -u \
                | tr '\n' ',' \
                | sed 's/,$//; s/,/, /g'
              )

              printf "| %s %-8s | %6d | %s | %s |\n" \
                "$emoji" "$ext" "$count" "$histogram" "$folder_unique"
            done

            printf "| **TOTAL** | %6d | | |\n" "$total_global"

          } > "$REPORT_PATH"

          # Show report preview
          echo "‚úÖ Laporan berhasil dibuat: $REPORT_PATH"
          echo "--- PREVIEW ---"
          head -20 "$REPORT_PATH"

      # ========== REPORT ROTATION ==========
      - name: 6. Rotasi Laporan Lama (Keep Last 7)
        id: rotate_reports
        run: |
          files=(mini/*-laporan_konten.md)
          if [ ${#files[@]} -gt 7 ]; then
            echo "üóëÔ∏è Menghapus laporan lama..."
            # Sort by date in filename
            sorted_files=($(printf '%s\n' "${files[@]}" | sort))
            files_to_delete=("${sorted_files[@]:0:${#sorted_files[@]}-7}")
            
            for file in "${files_to_delete[@]}"; do
              echo "‚Üí Menghapus: $file"
              rm -f "$file"
            done
            echo "Total dihapus: ${#files_to_delete[@]} file"
          else
            echo "‚ÑπÔ∏è  Tidak ada laporan yang perlu dihapus (${#files[@]}/7)"
          fi

      # ========== COMMIT CHANGES ==========
      - name: 7. Commit & Push All Changes
        id: commit_changes
        run: |
          # Configure Git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # Add all modified directories
          git add .
          
          # Check for changes
          if ! git diff --staged --quiet; then
            echo "üìù Perubahan ditemukan, membuat commit..."
            
            # Get changes summary
            added_count=$(git diff --staged --name-status | grep -c "^A" || true)
            deleted_count=$(git diff --staged --name-status | grep -c "^D" || true)
            
            git commit -m "chore: Daily maintenance report ($DATE) üìä
            
            - Added: $added_count file(s)
            - Deleted: $deleted_count file(s)
            - Report: ${DATE}-laporan_konten.md" \
              --author="frijal <5477182+frijal@users.noreply.github.com>"
            
            # Pull latest changes and push
            git pull origin main --rebase --strategy-option=theirs
            git push origin main
            
            echo "‚úÖ Perubahan berhasil di-commit dan di-push"
          else
            echo "‚úÖ Tidak ada perubahan baru untuk di-commit."
          fi
