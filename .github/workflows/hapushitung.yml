name: ğŸ”† Pengecekan & Laporan Konten Harian
on:
  schedule:
    - cron: '0 21 * * *'  # setiap hari pukul 21:00 UTC
  workflow_dispatch:

jobs:
  maintenance_and_reporting:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Generate Screenshots via NPM Script
      - name: 3. Generate Missing Screenshots
        run: |
          echo "ğŸ“¸ Menjalankan screenshot..."
          npm ci
          npm run ci-screenshot

      # 4. Cleanup Orphan .webp Images
      - name: 4. Cari dan Hapus Gambar Orphan (.webp)
        id: cleanup_step
        run: |
          echo "ğŸ§¹ Membersihkan gambar orphan (.webp)..."
          DELETED_COUNT=0
          mkdir -p img
          for file in img/*.webp; do
            [ -e "$file" ] || continue
            slug="${file##*/}"
            slug="${slug%.webp}"
            if [ ! -f "artikel/${slug}.html" ]; then
              echo "-> Orphan ditemukan: $file, menghapus..."
              git rm -f "$file"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            fi
          done
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ§¹ Total orphan .webp dihapus: $DELETED_COUNT"

      # 5. Hitung File & Buat Laporan Markdown per Folder
      - name: 5. Hitung File & Buat Laporan Markdown
        id: counts
        run: |
          echo "ğŸ“Š Membuat laporan markdown per folder..."
          DATE=$(date +'%m-%d')
          REPORT_PATH="mini/${DATE}-laporan_konten.md"
          mkdir -p mini

          # Folder yang akan dihitung
          FOLDERS=("artikel" "img")
          EXTENSIONS=("html" "webp" "png")

          # Mulai laporan
          {
            echo "# Laporan Konten Harian ($DATE)"
            echo ""
            echo "## Ringkasan File per Folder"
            echo ""
            for folder in "${FOLDERS[@]}"; do
              echo "### $folder"
              echo "| Jenis File | Jumlah |"
              echo "|------------|--------|"
              total=0
              for ext in "${EXTENSIONS[@]}"; do
                count=$(find "$folder" -maxdepth 1 -type f -iname "*.$ext" 2>/dev/null | wc -l)
                printf "| %-10s | %-6s |\n" "$ext" "$count"
                total=$((total + count))
              done
              printf "| %-10s | %-6s |\n" "TOTAL" "$total"
              echo ""
            done

            # Ringkasan keseluruhan
            echo "## Ringkasan Keseluruhan"
            echo "| Jenis File | Jumlah |"
            echo "|------------|--------|"
            total_all=0
            for ext in "${EXTENSIONS[@]}"; do
              count=$(find "${FOLDERS[@]}" -type f -iname "*.$ext" 2>/dev/null | wc -l)
              printf "| %-10s | %-6s |\n" "$ext" "$count"
              total_all=$((total_all + count))
            done
            printf "| %-10s | %-6s |\n" "TOTAL" "$total_all"
            echo ""
            echo "## URL File HTML"
            PREFIX="https://dalam.web.id/artikel/"
            find "artikel" -maxdepth 1 -type f -iname "*.html" 2>/dev/null | sed "s|^artikel/|$PREFIX|g" | sort | while read url; do
              echo "- $url"
            done
          } > "$REPORT_PATH"
          cat "$REPORT_PATH"

      # 6. Rotasi Laporan Lama
      - name: 6. Rotasi Laporan Lama
        run: |
          files=(mini/*-laporan_konten.md)
          if [ ${#files[@]} -gt 7 ]; then
            echo "ğŸ—‘ï¸ Menghapus laporan lama..."
            rm -f "${files[@]:7}"
          fi

      # 7. Commit Semua Perubahan Sekaligus
      - name: 7. Commit All Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'

          git add img/ mini/
          if ! git diff --staged --quiet; then
            echo "ğŸ“ Perubahan ditemukan, membuat commit..."
            git commit -m "chore: Daily maintenance (screenshots, cleanup, report)" --author="frijal <5477182+frijal@users.noreply.github.com>"
            git pull origin main --rebase
            git push
          else
            echo "âœ… Tidak ada perubahan baru untuk di-commit."
