name: Ganti Teks dalam File (via PR)

on:
  workflow_dispatch:
    inputs:
      search:
        description: "Set 1: Teks yang dicari (Wajib)"
        required: true
        default: ""
      replace:
        description: "Set 1: Teks pengganti"
        required: false
        default: ""
      search2:
        description: "Set 2: Teks dicari (Hanya jika Set 1 Match)"
        required: false
        default: ""
      replace2:
        description: "Set 2: Teks pengganti"
        required: false
        default: ""
      folder:
        description: "Folder target (kosongkan untuk root)"
        required: false
        default: ""
      globs:
        description: "Ekstensi file (koma-separated)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write
  workflows: write

jobs:
  replace-process:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: "Eksekusi Penggantian Teks"
        shell: bash
        env:
          S1: ${{ github.event.inputs.search }}
          R1: ${{ github.event.inputs.replace }}
          S2: ${{ github.event.inputs.search2 }}
          R2: ${{ github.event.inputs.replace2 }}
          TARGET: ${{ github.event.inputs.folder }}
        run: |
          IFS="," read -ra GLOBS <<< "${{ github.event.inputs.globs }}"
          
          for g in "${GLOBS[@]}"; do
            echo "ðŸ“‚ Scanning file dengan pola: $g"
            SEARCH_DIR="${TARGET:-.}"
            
            find "$SEARCH_DIR" -type f -wholename "$g" 2>/dev/null | while read -r file; do
              
              SET1_SUCCESS=false

              # --- PROSES SET 1 ---
              if [[ -n "$S1" ]]; then
                CLEAN_CHECK_S="${S1#^}"
                CLEAN_CHECK_S="${CLEAN_CHECK_S%\$}"

                # 1. Cek apakah teks target (S1) ada
                # 2. Cek apakah teks pengganti (R1) SUDAH ADA (Anti-Duplikat)
                if grep -Fq "$CLEAN_CHECK_S" "$file"; then
                  
                  if [[ -n "$R1" ]] && grep -Fq "$R1" "$file"; then
                    echo "  âš ï¸ Skip Set 1: Teks pengganti '$R1' sudah ada di $file (Mencegah duplikat)"
                    # Kita tetap anggap "Sukses" agar Set 2 bisa jalan jika diinginkan, 
                    # atau ubah ke false jika Set 2 bergantung pada perubahan fisik Set 1.
                    SET1_SUCCESS=true 
                  else
                    echo "  ðŸ” Match Set 1 di: $file. Mengganti..."
                    if [[ "$S1" == ^* ]]; then
                      CLEAN_S="${S1#^}"; perl -i -pe "s#^\Q$CLEAN_S\E#$R1#g" "$file" && SET1_SUCCESS=true
                    elif [[ "$S1" == *\$ ]]; then
                      CLEAN_S="${S1%\$}"; perl -i -pe "s#\Q$CLEAN_S\E\$#$R1#g" "$file" && SET1_SUCCESS=true
                    else
                      perl -i -pe "s#\Q$S1\E#$R1#g" "$file" && SET1_SUCCESS=true
                    fi
                  fi
                else
                  echo "  â­ï¸ Skip: Set 1 tidak ditemukan di $file"
                fi
              else
                SET1_SUCCESS=true 
              fi

              # --- PROSES SET 2 ---
              if [[ "$SET1_SUCCESS" == true && -n "$S2" ]]; then
                # Anti-duplikat untuk Set 2
                if [[ -n "$R2" ]] && grep -Fq "$R2" "$file"; then
                   echo "  âš ï¸ Skip Set 2: Teks pengganti '$R2' sudah ada di $file"
                else
                  echo "  â© Melanjutkan ke Set 2 di: $file"
                  if [[ "$S2" == ^* ]]; then
                    CLEAN_S="${S2#^}"; perl -i -pe "s#^\Q$CLEAN_S\E#$R2#g" "$file"
                  elif [[ "$S2" == *\$ ]]; then
                    CLEAN_S="${S2%\$}"; perl -i -pe "s#\Q$S2\E\$#$R2#g" "$file"
                  else
                    perl -i -pe "s#\Q$S2\E#$R2#g" "$file"
                  fi
                fi
              fi
            done
          done

      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: mass update content (with anti-duplicate check)"
          branch: "fix/mass-replace-${{ github.run_id }}"
          delete-branch: true
          title: "Mass Replace: ${{ github.event.inputs.search }}"
          body: |
            ## ðŸ“ Laporan Penggantian Teks (Mode Aman)
            Sistem mendeteksi dan melewati file yang sudah mengandung teks pengganti untuk mencegah duplikasi.
            
            ### Detail:
            - **Set 1:** `${{ github.event.inputs.search }}` -> `${{ github.event.inputs.replace }}`
            - **Set 2:** `${{ github.event.inputs.search2 }}` -> `${{ github.event.inputs.replace2 }}`
            
            ---
            *Processed via GitHub Actions.*
          labels: |
            automated-pr
            content-update
