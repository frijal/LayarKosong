name: Ganti Teks dalam File

on:
  workflow_dispatch:
    inputs:
      search:
        description: "Set 1: Teks yang dicari (Wajib)"
        required: true
        default: "<h1>"
      replace:
        description: "Set 1: Teks pengganti"
        required: false
        default: '<h1><a href="/" style="text-decoration: none; color: inherit;">'
      search2:
        description: "Set 2: Teks dicari (Opsional - Kosongkan jika tidak pakai)"
        required: false
        default: "</h1>"
      replace2:
        description: "Set 2: Teks pengganti (Opsional)"
        required: false
        default: "</a></h1>"
      folder:
        description: "Folder target"
        required: false
        default: "."
      globs:
        description: "Ekstensi file (koma-separated)"
        required: false
        default: "**/*.html,**/*.txt,**/*.md"

permissions:
  contents: write

jobs:
  replace-process:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Eksekusi Penggantian Teks"
        shell: bash
        env:
          # Set Pertama
          S1: ${{ github.event.inputs.search }}
          R1: ${{ github.event.inputs.replace }}
          # Set Kedua
          S2: ${{ github.event.inputs.search2 }}
          R2: ${{ github.event.inputs.replace2 }}
          TARGET: ${{ github.event.inputs.folder }}
        run: |
          IFS="," read -ra GLOBS <<< "${{ github.event.inputs.globs }}"
          
          for g in "${GLOBS[@]}"; do
            echo "üìÇ Scanning file: $g"
            find "$TARGET" -type f -path "$TARGET/$g" 2>/dev/null | while read -r file; do
              
              # PROSES SET 1 (UTAMA)
              if [[ -n "$S1" ]]; then
                if [[ "$S1" == ^* ]]; then
                  CLEAN_S="${S1#^}"; perl -i -pe "s#^\Q$CLEAN_S\E#$R1#g" "$file"
                elif [[ "$S1" == *\$ ]]; then
                  CLEAN_S="${S1%\$}"; perl -i -pe "s#\Q$CLEAN_S\E\$#$R1#g" "$file"
                else
                  perl -i -pe "s#\Q$S1\E#$R1#g" "$file"
                fi
              fi

              # PROSES SET 2 (OPSIONAL)
              if [[ -n "$S2" ]]; then
                if [[ "$S2" == ^* ]]; then
                  CLEAN_S="${S2#^}"; perl -i -pe "s#^\Q$CLEAN_S\E#$R2#g" "$file"
                elif [[ "$S2" == *\$ ]]; then
                  CLEAN_S="${S2%\$}"; perl -i -pe "s#\Q$CLEAN_S\E\$#$R2#g" "$file"
                else
                  perl -i -pe "s#\Q$S2\E#$R2#g" "$file"
                fi
              fi
              
              echo "  ‚úèÔ∏è  Processed: $file"
            done
          done

      - name: "Commit dan Push Perubahan"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: double mass update content" || echo "No changes"
          git push
