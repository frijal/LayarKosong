name: "Mass Replace via Sed (PR)"

on:
  workflow_dispatch:
    inputs:
      search_text:
        description: "Teks/Kalimat yang dicari"
        required: true
      replace_text:
        description: "Teks/Kalimat pengganti"
        required: false
      extensions:
        description: "Ekstensi file (koma-separated, misal: md,ts,js). Kosongkan untuk semua file."
        required: false
        default: "html"
      folder:
        description: "Lokasi folder (default: .)"
        required: false
        default: "."

permissions:
  contents: write
  pull-requests: write
  workflows: write

jobs:
  replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Run Filtered Replacement
        shell: bash
        run: |
          SEARCH="${{ github.event.inputs.search_text }}"
          REPLACE="${{ github.event.inputs.replace_text }}"
          TARGET="${{ github.event.inputs.folder }}"
          EXT="${{ github.event.inputs.extensions }}"

          # Membangun array argumen pencarian ekstensi
          # Menggunakan Array jauh lebih aman daripada string + eval
          FIND_EXT_ARGS=()
          
          if [ -n "$EXT" ]; then
            IFS=',' read -ra ADDR <<< "$EXT"
            FIND_EXT_ARGS+=("(")
            first=true
            for i in "${ADDR[@]}"; do
              clean_ext="*.${i// /}"
              if [ "$first" = true ]; then
                FIND_EXT_ARGS+=("-name" "$clean_ext")
                first=false
              else
                FIND_EXT_ARGS+=("-o" "-name" "$clean_ext")
              fi
            done
            FIND_EXT_ARGS+=(")")
          else
            FIND_EXT_ARGS+=("-type" "f")
          fi

          echo "ðŸ” Mencari: \"$SEARCH\" -> \"$REPLACE\""
          echo "ðŸ“‚ Filter Ekstensi: $EXT"

          # Eksekusi find TANPA eval. 
          # "${FIND_EXT_ARGS[@]}" akan diekspansi dengan benar beserta tanda kurungnya.
          find "$TARGET" -type f "${FIND_EXT_ARGS[@]}" \
            -not -path '*/node_modules/*' \
            -not -path '*/functions/*' \
            -not -path '*/img/*' \
            -not -path '*/mini/*' \
            -not -path '*/sementara/*' \
            -exec sed -i "s#$SEARCH#$REPLACE#g" {} +
          
          echo "âœ… Penggantian selesai!"

      - name: "Check Git Status"
        id: status
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "::notice::Tidak ada perubahan pada ekstensi file tersebut."
          fi

      - name: "Create Pull Request"
        if: steps.status.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: ganti text pada file $EXT"
          branch: "ganti-txt/${{ github.run_id }}"
          delete-branch: true
          title: "Mass Replace (${{ github.event.inputs.extensions }}): ${{ github.event.inputs.search_text }}"
          body: |
            ## ðŸ¤– Automated Replacement Report
            
            - **Cari:** `${{ github.event.inputs.search_text }}`
            - **Ganti:** `${{ github.event.inputs.replace_text }}`
            - **Ekstensi:** `${{ github.event.inputs.extensions }}`
            - **Folder:** `${{ github.event.inputs.folder }}`
