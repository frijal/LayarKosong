name: "ðŸš€ Mass Replace via Bun"

on:
  workflow_dispatch:
    inputs:
      search_text:
        description: "Teks yang dicari"
        required: true
      replace_text:
        description: "Teks pengganti"
        required: true
      folder:
        description: "Lokasi folder (default: .)"
        required: false
        default: "."
      extensions:
        description: "Ekstensi file (misal: .ts,.js,.md)"
        required: false
        default: ".ts,.tsx,.js,.jsx,.md"

permissions:
  contents: write
  pull-requests: write

jobs:
  replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: Run Replacement Script
        id: replacement
        env:
          SEARCH: ${{ github.event.inputs.search_text }}
          REPLACE: ${{ github.event.inputs.replace_text }}
          TARGET_DIR: ${{ github.event.inputs.folder }}
          EXTENSIONS: ${{ github.event.inputs.extensions }}
        run: |
          cat << 'EOF' > sementara/replace-script.ts
          import { join } from "path";
          import { readdir } from "fs/promises";

          const targetDir = process.env.TARGET_DIR || ".";
          const search = process.env.SEARCH;
          const replace = process.env.REPLACE;
          const extensions = process.env.EXTENSIONS?.split(",").map(e => e.trim()) || [".ts", ".js", ".md"];

          async function processFiles(dir: string) {
            const entries = await readdir(dir, { withFileTypes: true });
            for (const entry of entries) {
              const fullPath = join(dir, entry.name);
              if (entry.isDirectory()) {
                if (["node_modules", ".git", "dist"].includes(entry.name)) continue;
                await processFiles(fullPath);
              } else if (extensions.some(ext => entry.name.endsWith(ext))) {
                const file = Bun.file(fullPath);
                const content = await file.text();
                if (content.includes(search!)) {
                  const updatedContent = content.split(search!).join(replace!);
                  await Bun.write(fullPath, updatedContent);
                  console.log(`âœ… Updated: ${fullPath}`);
                }
              }
            }
          }
          await processFiles(targetDir);
          EOF
          bun run sementara/replace-script.ts

      - name: "Check Git Status"
        id: status
        run: |
          git status
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "::notice::Tidak ada perubahan ditemukan."
          fi

      - name: "Create Pull Request"
        if: steps.status.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: mass replace ${{ github.event.inputs.search_text }}"
          branch: "automation/replace-${{ github.run_id }}"
          title: "Mass Replace: ${{ github.event.inputs.search_text }}"
          body: "Automated replacement of `${{ github.event.inputs.search_text }}` with `${{ github.event.inputs.replace_text }}`"
