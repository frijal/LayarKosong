name: Mass Replace and Create PR

on:
  workflow_dispatch:
    inputs:
      search:
        description: 'Teks yang akan dicari (literal string)'
        required: true
        type: string
      replace:
        description: 'Teks pengganti'
        required: true
        type: string
      path:
        description: 'Root path untuk pencarian (default .)'
        required: false
        default: '.'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  mass-replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run search and replace
        id: replace
        run: |
          set -euo pipefail
          SEARCH="${{ github.event.inputs.search }}"
          REPLACE="${{ github.event.inputs.replace }}"
          ROOT="${{ github.event.inputs.path }}"

          python3 - <<'PY'
          import os
          from pathlib import Path

          search = os.environ['SEARCH']
          replace = os.environ['REPLACE']
          root = Path(os.environ['ROOT'])

          skip_dirs = {'.git', 'node_modules', '.venv', 'venv', '.pytest_cache', '.gradle', 'build'}
          binary_signatures = [b'\x00']

          def is_binary(path: Path) -> bool:
              try:
                  with path.open('rb') as f:
                      return b'\x00' in f.read(1024)
              except Exception:
                  return True

          changed_files = []

          for p in root.rglob('*'):
              if p.is_dir() and p.name in skip_dirs:
                  continue

              if p.is_file() and not any(part in skip_dirs for part in p.parts):
                  try:
                      if is_binary(p):
                          continue
                      text = p.read_text(encoding='utf-8')
                  except Exception:
                      continue

                  if search in text:
                      new_text = text.replace(search, replace)
                      if new_text != text:
                          p.write_text(new_text, encoding='utf-8')
                          changed_files.append(str(p))

          if changed_files:
              print("Changed files:")
              for f in changed_files:
                  print(f"- {f}")
          else:
              print("No changes detected.")
          PY

      - name: Check git changes
        id: git-check
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: ${{ steps.git-check.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: mass replace '${{ github.event.inputs.search }}'"
          branch: "chore/mass-replace-${{ github.run_id }}"
          title: "Mass replace: '${{ github.event.inputs.search }}'"
          body: |
            ğŸ” **Automated Mass Replace**

            **Target:** `${{ github.event.inputs.search }}`
            **Replacement:** `${{ github.event.inputs.replace }}`
            **Path:** `${{ github.event.inputs.path }}`

            Silakan review perubahan di PR ini sebelum merge ğŸ™
