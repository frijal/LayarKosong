name: Mass Replace and Create PR

on:
  workflow_dispatch:
    inputs:
      search:
        description: 'Teks yang akan dicari (literal string)'
        required: true
        type: string
      replace:
        description: 'Teks pengganti'
        required: true
        type: string
      path:
        description: 'Root path untuk pencarian (default .)'
        required: false
        default: '.'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  mass-replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run search and replace
        id: replace
        run: |
          set -euo pipefail
          SEARCH="${{ github.event.inputs.search }}"
          REPLACE="${{ github.event.inputs.replace }}"
          ROOT="${{ github.event.inputs.path }}"

          # Find text files and replace in-place. Skip .git and common binary dirs.
          # This Python approach avoids corrupting binary files.
          python3 - <<'PY'
          import os
          from pathlib import Path

          search = os.environ['SEARCH']
          replace = os.environ['REPLACE']
          root = Path(os.environ['ROOT'])

          # file extensions to skip (add more if needed)
          skip_dirs = {'.git', 'node_modules', '.venv', 'venv', '.pytest_cache', '.gradle', 'build'}
          binary_signatures = [b'\x00']

          def is_binary(path: Path) -> bool:
              try:
                  with path.open('rb') as f:
                      chunk = f.read(1024)
                      return any(sig in chunk for sig in binary_signatures)
              except Exception:
                  return True

          for p in root.rglob('*'):
              if p.is_dir():
                  if p.name in skip_dirs:
                      continue

              if p.is_file():
                  if any(part in skip_dirs for part in p.parts):
                      continue
                  try:
                      if is_binary(p):
                          continue
                      text = p.read_text(encoding='utf-8')
                  except Exception:
                      # skip files we can't decode as utf-8
                      continue

                  if search in text:
                      new = text.replace(search, replace)
                      if new != text:
                          p.write_text(new, encoding='utf-8')
                          print(f"Replaced in: {p}")
          PY

      - name: Stage changes and check if anything changed
        id: git-check
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: ${{ steps.git-check.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: mass update content"
          branch: "fix/mass-replace-${{ github.run_id }}"
          title: "Mass Replace: ${{ github.event.inputs.search }}"
          body: |
            Automated text replacement report.
            - **Target**: `${{ github.event.inputs.search }}`
            - **Replacement**: `${{ github.event.inputs.replace }}`
            - **Path**: `${{ github.event.inputs.path }}`
