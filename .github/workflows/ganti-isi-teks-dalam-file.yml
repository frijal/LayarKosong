name: Ganti Teks dalam File

on:
  workflow_dispatch:
    inputs:
      search:
        description: "Teks yang dicari. Gunakan ^ untuk awal baris, $ untuk akhir baris. Contoh: ' | Layar Kosong$'"
        required: true
        default: ' | Layar Kosong$'
      replace:
        description: 'Teks pengganti (kosongkan jika ingin menghapus teks tersebut)'
        required: false
        default: ''
      folder:
        description: 'Folder target (Contoh: content atau . untuk semua)'
        required: false
        default: '.'
      globs:
        description: 'Ekstensi file (pisahkan dengan koma)'
        required: false
        default: '**/*.html,**/*.txt,**/*.md'

permissions:
  contents: write

jobs:
  replace-process:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Eksekusi Penggantian Teks'
        shell: bash
        env:
          RAW_SEARCH: ${{ github.event.inputs.search }}
          RAW_REPLACE: ${{ github.event.inputs.replace }}
          TARGET: ${{ github.event.inputs.folder }}
        run: |
          # Membaca input globs menjadi array
          IFS=',' read -ra GLOBS <<< '${{ github.event.inputs.globs }}'
          
          echo "üîç Memulai pencarian untuk: $RAW_SEARCH"
          echo "üîÑ Mengganti menjadi: $RAW_REPLACE"

          for g in '${GLOBS[@]}'; do
            echo "üìÇ Scanning file dengan pola: $g"
            
            # Find file sesuai folder dan pola
            find "$TARGET" -type f -path "$TARGET/$g" 2>/dev/null | while read -r file; do
              
              if [[ "$RAW_SEARCH" == ^* ]]; then
                # MODE AWAL BARIS: Misal '^  '
                # Menghapus karakter ^ di variabel untuk diolah Perl
                CLEAN_S="${RAW_SEARCH#^}"
                echo "  ‚úèÔ∏è  Modifikasi Awal Baris: $file"
                perl -i -pe "s#^\Q$CLEAN_S\E#$RAW_REPLACE#g" "$file"

              elif [[ "$RAW_SEARCH" == *\$ ]]; then
                # MODE AKHIR BARIS: Misal ' | Layar Kosong$'
                # Menghapus karakter $ di variabel untuk diolah Perl
                CLEAN_S="${RAW_SEARCH%\$}"
                echo "  ‚úèÔ∏è  Modifikasi Akhir Baris: $file"
                perl -i -pe "s#\Q$CLEAN_S\E\$#$RAW_REPLACE#g" "$file"

              else
                # MODE TEKS BIASA: Cari di posisi mana saja
                echo "  ‚úèÔ∏è  Modifikasi Teks Biasa: $file"
                perl -i -pe "s#\Q$RAW_SEARCH\E#$RAW_REPLACE#g" "$file"
              fi
            done
          done

      - name: 'Commit dan Push Perubahan'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          # Pesan commit sederhana agar tidak error karena karakter spesial
          git commit -m 'chore: content mass update via workflow' || echo 'Tidak ada perubahan yang ditemukan'
          git push
