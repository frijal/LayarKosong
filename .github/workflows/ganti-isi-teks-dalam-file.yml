name: Mass Replace and Create PR

on:
  workflow_dispatch:
    inputs:
      search:
        description: 'Teks / Regex yang akan dicari'
        required: true
        type: string
      replace:
        description: 'Teks pengganti'
        required: true
        type: string
      path:
        description: 'Root path untuk pencarian (default .)'
        required: false
        default: '.'
        type: string
      extensions:
        description: 'Filter ekstensi file (contoh: .md,.txt,.js). Kosong = semua file teks'
        required: false
        default: ''
        type: string
      case_insensitive:
        description: 'Case-insensitive replace? (true/false)'
        required: true
        default: 'false'
        type: string
      use_regex:
        description: 'Gunakan regex? (true/false)'
        required: true
        default: 'false'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  mass-replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run search and replace
        id: replace
        run: |
          set -euo pipefail
          SEARCH="${{ github.event.inputs.search }}"
          REPLACE="${{ github.event.inputs.replace }}"
          ROOT="${{ github.event.inputs.path }}"
          EXTENSIONS="${{ github.event.inputs.extensions }}"
          CASE_INSENSITIVE="${{ github.event.inputs.case_insensitive }}"
          USE_REGEX="${{ github.event.inputs.use_regex }}"

          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          search = os.environ['SEARCH']
          replace = os.environ['REPLACE']
          root = Path(os.environ['ROOT'])
          extensions_raw = os.environ['EXTENSIONS']
          case_insensitive = os.environ['CASE_INSENSITIVE'].lower() == 'true'
          use_regex = os.environ['USE_REGEX'].lower() == 'true'

          skip_dirs = {'.git', 'node_modules', '.venv', 'venv', '.pytest_cache', '.gradle', 'build'}
          binary_signatures = [b'\x00']

          def is_binary(path: Path) -> bool:
              try:
                  with path.open('rb') as f:
                      return b'\x00' in f.read(1024)
              except Exception:
                  return True

          extensions = []
          if extensions_raw.strip():
              extensions = [e.strip().lower() for e in extensions_raw.split(',') if e.strip()]

          flags = re.IGNORECASE if case_insensitive else 0
          pattern = re.compile(search, flags) if use_regex else None

          changed = []

          for p in root.rglob('*'):
              if p.is_dir() and p.name in skip_dirs:
                  continue

              if not p.is_file():
                  continue

              if any(part in skip_dirs for part in p.parts):
                  continue

              if extensions:
                  if p.suffix.lower() not in extensions:
                      continue

              try:
                  if is_binary(p):
                      continue
                  text = p.read_text(encoding='utf-8')
              except Exception:
                  continue

              if use_regex:
                  new_text, count = pattern.subn(replace, text)
              else:
                  if case_insensitive:
                      new_text, count = re.subn(re.escape(search), replace, text, flags=re.IGNORECASE)
                  else:
                      count = text.count(search)
                      new_text = text.replace(search, replace)

              if count > 0 and new_text != text:
                  p.write_text(new_text, encoding='utf-8')
                  changed.append(f"{p} ({count} replace)")

          if changed:
              print("Changed files:")
              for f in changed:
                  print("-", f)
          else:
              print("No changes detected.")
          PY

      - name: Check git changes
        id: git-check
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: ${{ steps.git-check.outputs.changed == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: mass replace '${{ github.event.inputs.search }}'"
          branch: "chore/mass-replace-${{ github.run_id }}"
          title: "Mass replace: '${{ github.event.inputs.search }}'"
          body: |
            üîÅ **Automated Mass Replace**

            **Target:** `${{ github.event.inputs.search }}`
            **Replacement:** `${{ github.event.inputs.replace }}`
            **Path:** `${{ github.event.inputs.path }}`
            **Extensions:** `${{ github.event.inputs.extensions || 'ALL' }}`
            **Case-insensitive:** `${{ github.event.inputs.case_insensitive }}`
            **Regex:** `${{ github.event.inputs.use_regex }}`

            Silakan review PR ini sebelum merge üöÄ
