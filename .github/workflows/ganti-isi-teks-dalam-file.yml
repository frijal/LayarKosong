name: Ganti Teks dalam File (via PR)

on:
  workflow_dispatch:
    inputs:
      search:
        description: "Set 1: Teks yang dicari (Wajib)"
        required: true
        default: ""
      replace:
        description: "Set 1: Teks pengganti"
        required: false
        default: ''
      search2:
        description: "Set 2: Teks dicari (Opsional)"
        required: false
        default: ""
      replace2:
        description: "Set 2: Teks pengganti (Opsional)"
        required: false
        default: ""
      folder:
        description: "Folder target"
        required: false
        default: ""
      globs:
        description: "Ekstensi file (koma-separated)"
        required: false
        default: "**/*.html,**/*.txt,**/*.md"

permissions:
  contents: write
  pull-requests: write # Wajib ada untuk bikin PR

jobs:
  replace-process:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Eksekusi Penggantian Teks"
        shell: bash
        env:
          S1: ${{ github.event.inputs.search }}
          R1: ${{ github.event.inputs.replace }}
          S2: ${{ github.event.inputs.search2 }}
          R2: ${{ github.event.inputs.replace2 }}
          TARGET: ${{ github.event.inputs.folder }}
        run: |
          IFS="," read -ra GLOBS <<< "${{ github.event.inputs.globs }}"
          
          for g in "${GLOBS[@]}"; do
            echo "üìÇ Scanning file: $g"
            # Perbaikan find: menggunakan -wholename agar globbing jalan dengan benar
            find "$TARGET" -type f -wholename "$g" 2>/dev/null | while read -r file; do
              
              # PROSES SET 1
              if [[ -n "$S1" ]]; then
                if [[ "$S1" == ^* ]]; then
                  CLEAN_S="${S1#^}"; perl -i -pe "s#^\Q$CLEAN_S\E#$R1#g" "$file"
                elif [[ "$S1" == *\$ ]]; then
                  CLEAN_S="${S1%\$}"; perl -i -pe "s#\Q$CLEAN_S\E\$#$R1#g" "$file"
                else
                  perl -i -pe "s#\Q$S1\E#$R1#g" "$file"
                fi
              fi

              # PROSES SET 2
              if [[ -n "$S2" ]]; then
                if [[ "$S2" == ^* ]]; then
                  CLEAN_S="${S2#^}"; perl -i -pe "s#^\Q$CLEAN_S\E#$R2#g" "$file"
                elif [[ "$S2" == *\$ ]]; then
                  CLEAN_S="${S2%\$}"; perl -i -pe "s#\Q$CLEAN_S\E\$#$R2#g" "$file"
                else
                  perl -i -pe "s#\Q$S2\E#$R2#g" "$file"
                fi
              fi
              
              echo "  ‚úèÔ∏è  Processed: $file"
            done
          done

      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@v5
        with:
          # Disarankan pakai GITHUB_TOKEN bawaan saja jika tidak butuh trigger workflow lain
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: mass update content (Set 1: ${{ github.event.inputs.search }})"
          branch: "fix/mass-replace-${{ github.run_id }}" # Branch unik tiap kali jalan
          delete-branch: true
          title: "Mass Replace: ${{ github.event.inputs.search }}"
          body: |
            ## üìù Deskripsi Perubahan
            Melakukan penggantian teks otomatis pada folder `${{ github.event.inputs.folder }}`.

            ### Set 1:
            - **Cari:** `${{ github.event.inputs.search }}`
            - **Ganti:** `${{ github.event.inputs.replace }}`

            ### Set 2 (Jika diisi):
            - **Cari:** `${{ github.event.inputs.search2 }}`
            - **Ganti:** `${{ github.event.inputs.replace2 }}`

            ---
            *Otomatis dibuat oleh GitHub Actions.*
          labels: |
            automated-pr
            content-update
