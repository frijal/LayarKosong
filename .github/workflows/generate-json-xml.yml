name: ‚ò¢Ô∏è Build and Generate Site Files

on:
  workflow_run:
    workflows: ["üîÑ Proses ArtikelX"]
    types: [completed]
    branches: ['main']
  workflow_dispatch:
    inputs:
      run_generator:
        description: 'Jalankan Generator (JSON, RSS, Sitemap XML)'
        type: boolean
        default: true
      run_sitemap_txt:
        description: 'Jalankan Update sitemap.txt'
        type: boolean
        default: true
      run_schema:
        description: 'Jalankan Inject Schema.org Python'
        type: boolean
        default: true
      run_minify_html:
        description: 'Jalankan HTML Minify'
        type: boolean
        default: true
      run_minify_jsonxml:
        description: 'Jalankan JSONXML Minify'
        type: boolean
        default: true
      run_convert_markdown:
        description: 'ubah ke format markdown'
        type: boolean
        default: true
  schedule:
    - cron: '0 12 * * *'

env:
  DO_GENERATOR: ${{ github.event.inputs.run_generator || 'true' }}
  DO_SITEMAP_TXT: ${{ github.event.inputs.run_sitemap_txt || 'true' }}
  DO_SCHEMA: ${{ github.event.inputs.run_schema || 'true' }}
  DO_MINIFY_HTML: ${{ github.event.inputs.run_minify_html || 'true' }}
  DO_MINIFY_JSONXML: ${{ github.event.inputs.run_minify_jsonxml || 'true' }}
  DO_CONVERT_MARKDOWN : ${{ github.event.inputs.run_convert_markdown || 'true' }}

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Cache Node Modules
        uses: actions/cache@v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: '2. Setup Node.js'
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24'

      - name: '3. Install Dependencies'
        run: npm ci

      - name: '4. Setup Python' # Dibutuhkan untuk step Schema nanti
        if: env.DO_SCHEMA == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: '5Ô∏è‚É£ Generate artikel.json, Sitemap XML & RSS'
        if: env.DO_GENERATOR == 'true'
        run: npm run ci-generate-xml-rss
        env:
          RSS_LIMIT: 30

      - name: '6Ô∏è‚É£ Generate sitemap.txt'
        if: env.DO_SITEMAP_TXT == 'true'
        run: |
          echo "üìù Membuat sitemap.txt..."
          BASE_URL="https://dalam.web.id"
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('artikel.json', 'utf8'));
            const urls = [];
            const slugify = (t) => t.toLowerCase().trim().replace(/\s+/g, '-');
            for (const [cat, posts] of Object.entries(data)) {
              posts.forEach(p => {
                const fileSlug = p[1].replace('.html', '').replace(/^\//, '');
                urls.push('${BASE_URL}/' + slugify(cat) + '/' + fileSlug + '/');
              });
            }
            ['/', '/jejak-sejarah/', '/lainnya/', '/olah-media/', '/opini-sosial/', '/sistem-terbuka/', '/warta-tekno/', '/gaya-hidup/', '/about/', '/privacy/', '/search/', '/security-policy/', '/data-deletion-form/', '/disclaimer/', '/feed/', '/img/', '/lisensi/', '/sitemap/'].forEach(u => urls.push('${BASE_URL}' + u));
            fs.writeFileSync('sitemap.txt', [...new Set(urls)].join('\n') + '\n');
          "
     
      - name: '7Ô∏è‚É£ Inject schema.org (BARU KEMUDIAN)'
        if: env.DO_SCHEMA == 'true'
        run: python3 ext/inject_schema.py

      - name: üìù Convert HTML Tags to Markdown (Node.js)
        if: env.DO_CONVERT_MARKDOWN == 'true'
        run: node ext/html-to-markdown.js
        
      - name: '8Ô∏è‚É£ Clean HTML Cerdas (html-minifier-terser)'
        if: env.DO_MINIFY_HTML == 'true'
        run: node ext/minify-html.js

      - name: üßπ Minify Data (JSON & XML)
        if: env.DO_MINIFY_JSONXML == 'true'
        run: node ext/minify-jsonxml.js     

      - name: '9Ô∏è‚É£ Commit and Push'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "‚úÖ Tidak ada perubahan."
          else
            git commit -m "build: üöÄ site assets (webp mirrors, json, rss, sitemap)"
            git pull --rebase origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
