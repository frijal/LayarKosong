name: ‚ò¢Ô∏è Build and Generate Site Files

on:
  workflow_run:
    workflows: ["üîÑ Proses ArtikelX"]
    types: [completed]
    branches: ['main']
  workflow_dispatch:
    inputs:
      run_generator:
        description: 'Jalankan Generator (JSON, RSS, Sitemap XML)'
        type: boolean
        default: true
      run_sitemap_txt:
        description: 'Jalankan Update sitemap.txt'
        type: boolean
        default: true
      run_schema:
        description: 'Jalankan Inject Schema.org (Rust)'
        type: boolean
        default: true
      run_minify_html:
        description: 'Jalankan HTML Minify (Rust)'
        type: boolean
        default: true
      run_minify_jsonxml:
        description: 'Jalankan JSONXML Minify (Rust)'
        type: boolean
        default: true
      run_convert_markdown:
        description: 'Ubah format HTML ke Markdown (Rust)'
        type: boolean
        default: true  

env:
  DO_GENERATOR: ${{ github.event.inputs.run_generator || 'true' }}
  DO_SITEMAP_TXT: ${{ github.event.inputs.run_sitemap_txt || 'true' }}
  DO_SCHEMA: ${{ github.event.inputs.run_schema || 'true' }}
  DO_MINIFY_HTML: ${{ github.event.inputs.run_minify_html || 'true' }}
  DO_MINIFY_JSONXML: ${{ github.event.inputs.run_minify_jsonxml || 'true' }}
  DO_CONVERT_MARKDOWN: ${{ github.event.inputs.run_convert_markdown || 'true' }}

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4 # Pakai versi terbaru v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 1

      - name: '2. Setup Rust Toolchain'
        uses: dtolnay/rust-toolchain@stable

      # GANTI STEP 3 LAMA DENGAN INI
      - name: '3. Rust Cache Engine'
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          # Ini penting supaya cache tidak bentrok antar binary
          shared-key: "layarkosong-engine"

      - name: '4. Build All Tools (Pre-compile)'
        # Tambahkan --quiet supaya log tidak penuh dan sedikit lebih cepat
        run: cargo build --release --quiet

      - name: '5. Run Generator-Pro (Rust)'
        if: env.DO_GENERATOR == 'true'
        run: ./target/release/generator-pro

      - name: '6. Generate sitemap.txt (Rust Engine)'
        if: env.DO_SITEMAP_TXT == 'true'
        run: ./target/release/sitemap-txt

      - name: '7. Inject SEO Schema (Rust)'
        if: env.DO_SCHEMA == 'true'
        run: ./target/release/inject-schema

      - name: '8. Convert HTML to Markdown (Rust)'
        if: env.DO_CONVERT_MARKDOWN == 'true'
        run: ./target/release/html-to-markdown
        
      - name: '9. Minify HTML (Rust Ultra)'
        if: env.DO_MINIFY_HTML == 'true'
        run: ./target/release/minify-html

      - name: '10. Minify Data JSON & XML (Rust)'
        if: env.DO_MINIFY_JSONXML == 'true'
        run: ./target/release/minify-jsonxml

      - name: '11. Commit and Push'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "‚úÖ Tidak ada perubahan."
          else
            git commit -m "build: üöÄ optimized assets via Rust engine"
            git pull --rebase origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
