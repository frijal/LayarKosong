name: â˜¢ï¸ Build and Generate Site Files

on:
  push:
    branches: ['main']
    paths:
      - 'artikel/*.html'
  workflow_run:
    workflows: ["ğŸ”„ Proses ArtikelX"]
    types: [completed]
    branches: ['main']
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    # Jalankan jika bukan dipicu workflow_run, atau jika workflow_run sukses
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: '2. Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: '3. Install Dependencies'
        run: npm ci

      - name: '4ï¸âƒ£ Maintenance SEO (Main Folder)'
        # Memastikan semua file di folder utama sudah rapi
        run: npm run ci-fix-meta-main

      - name: '5ï¸âƒ£ Generate artikel.json, Sitemap XML & RSS'
        # Menggunakan generator-pro yang sudah digabung
        run: npm run ci-generate-xml-rss
        env:
          RSS_LIMIT: 30

      - name: '6ï¸âƒ£ Generate sitemap.txt (Static URL List)'
        # Tetap mempertahankan sitemap.txt sebagai pelengkap sitemap.xml
        run: |
          echo "ğŸ“ Membuat sitemap.txt..."
          BASE_URL="https://dalam.web.id"
          SITEMAP_FILE="sitemap.txt"

          # Ambil daftar artikel tanpa ekstensi .html
          find artikel/ -maxdepth 1 -name "*.html" \
            | sed 's_artikel/__; s_\.html$__' \
            | sed "s_^_$BASE_URL/artikel/_" > "$SITEMAP_FILE"

          # Tambahkan URL statis lainnya
          echo "$BASE_URL/" >> "$SITEMAP_FILE"
          echo "$BASE_URL/data-deletion" >> "$SITEMAP_FILE"
          echo "$BASE_URL/data-deletion-form" >> "$SITEMAP_FILE"
          echo "$BASE_URL/disclaimer" >> "$SITEMAP_FILE"
          echo "$BASE_URL/feed" >> "$SITEMAP_FILE"
          echo "$BASE_URL/search" >> "$SITEMAP_FILE"
          echo "$BASE_URL/security-policy" >> "$SITEMAP_FILE"
          echo "$BASE_URL/sitemap" >> "$SITEMAP_FILE"

          echo "âœ… sitemap.txt selesai"

      - name: '7ï¸âƒ£ Generate Screenshots'
        run: npm run ci-screenshot

      - name: '8ï¸âƒ£ Clean Empty Lines (HTML Minify Lite)'
        run: |
          echo "ğŸ§¹ Membersihkan baris kosong di folder artikel/..."
          set -euo pipefail
          shopt -s nullglob
          for file in artikel/*.html; do
            # Menghapus baris yang kosong atau hanya berisi whitespace
            # Lalu mengganti multiple blank lines menjadi single blank line (opsional)
            # Di sini kita pilih yang agresif: hapus semua baris kosong.
            sed -i '/^[[:space:]]*$/d' "$file"
          done
          echo "âœ… Pembersihan selesai."

      - name: '9ï¸âƒ£ Commit and Push Generated Files'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "âœ… Tidak ada perubahan file."
          else
            git commit -m "build: ğŸš€ generate site assets (webp mirrors, json, rss, sitemap)"
            git pull --rebase origin main || git pull origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Summary'
        if: always()
        run: |
          echo "âœ… Build & Mirroring selesai"
          echo "ğŸ”— RSS Utama    : https://dalam.web.id/rss.xml"
          echo "ğŸ”— Sitemap XML  : https://dalam.web.id/sitemap.xml"
          echo "ğŸ”— Sitemap TXT  : https://dalam.web.id/sitemap.txt"
          echo "Triggered by: ${{ github.event_name }}"
