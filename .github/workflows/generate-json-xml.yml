name: â˜¢ï¸ Build and Generate Site Files

on:
  push:
    branches: ['main']
    paths:
      - 'artikel/*.html'

  workflow_run:
    workflows: ["ğŸ”„ Proses ArtikelX"]
    types: [completed]
    branches: ['main']

  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: '2. Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: '3. Install Dependencies'
        run: npm ci

      - name: '4ï¸âƒ£ Generate artikel.json & RSS'
        run: npm run ci-generate-xml-rss
        env:
          RSS_LIMIT: 30

      - name: '5ï¸âƒ£ Generate Sitemap Rekursif & URL Statis'
        run: |
          echo "ğŸ“ Membuat sitemap.txt..."
          BASE_URL="https://dalam.web.id"
          SITEMAP_FILE="sitemap.txt"

          find artikel/ -name "*.html" \
            | sed 's_\.html$__' \
            | sed "s_^_$BASE_URL/_" > "$SITEMAP_FILE"

          echo "$BASE_URL/" >> "$SITEMAP_FILE"
          echo "$BASE_URL/data-deletion" >> "$SITEMAP_FILE"
          echo "$BASE_URL/data-deletion-form" >> "$SITEMAP_FILE"
          echo "$BASE_URL/disclaimer" >> "$SITEMAP_FILE"
          echo "$BASE_URL/feed" >> "$SITEMAP_FILE"
          echo "$BASE_URL/img" >> "$SITEMAP_FILE"
          echo "$BASE_URL/search" >> "$SITEMAP_FILE"
          echo "$BASE_URL/security-policy" >> "$SITEMAP_FILE"
          echo "$BASE_URL/sitemap" >> "$SITEMAP_FILE"

          echo "âœ… sitemap.txt selesai"

      - name: '6ï¸âƒ£ Generate Screenshots'
        run: npm run ci-screenshot

      - name: '7ï¸âƒ£ Commit and Push Generated Files'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "âœ… Tidak ada perubahan file."
            if [[ "${{ github.event_name }}" != "push" ]]; then
              exit 0
            fi
          fi

          git commit -m "build: ğŸš€ generate site assets"
          git pull --rebase origin main || git pull origin main
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: '8ï¸âƒ£ Summary'
        if: always()
        run: |
          echo "âœ… Build selesai"
          echo "ğŸ”— artikel.json: https://dalam.web.id/artikel.json"
          echo "ğŸ”— rss.xml     : https://dalam.web.id/rss.xml"
          echo "ğŸ”— sitemap.txt : https://dalam.web.id/sitemap.txt"
          echo "Triggered by: ${{ github.event_name }}"
