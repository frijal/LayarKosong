name: â˜¢ï¸ Build and Generate Site Files

on:
  workflow_run:
    workflows: ["ğŸ”„ Proses ArtikelX"]
    types: [completed]
    branches: ['main']
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    # Jalankan jika bukan dipicu workflow_run, atau jika workflow_run sukses
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v6.0.0
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Cache Node Modules
        uses: actions/cache@v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: '2. Setup Node.js'
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24'

      - name: '3. Install Dependencies'
        run: npm ci

      - name: '5ï¸âƒ£ Generate artikel.json, Sitemap XML & RSS'
        # Menggunakan generator-pro yang sudah digabung
        run: npm run ci-generate-xml-rss
        env:
          RSS_LIMIT: 30

      - name: '6ï¸âƒ£ Generate sitemap.txt (Sync V6.9)'
        # Kita ambil datanya langsung dari hasil generator-pro (artikel.json)
        # Ini cara paling akurat agar sitemap.txt sama persis dengan sitemap.xml
        run: |
          echo "ğŸ“ Membuat sitemap.txt dari database V6.9..."
          BASE_URL="https://dalam.web.id"
          SITEMAP_FILE="sitemap.txt"
          
          # Pakai node sebentar buat extract URL dari artikel.json
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('artikel.json', 'utf8'));
            const urls = [];
            const slugify = (t) => t.toLowerCase().trim().replace(/\s+/g, '-');
            
            for (const [cat, posts] of Object.entries(data)) {
              posts.forEach(p => {
                const fileSlug = p[1].replace('.html', '').replace(/^\//, '');
                urls.push('${BASE_URL}/' + slugify(cat) + '/' + fileSlug + '/');
              });
            }
            // Tambahkan URL Statis
            ['/', '/jejak-sejarah/', '/lainnya/', '/olah-media/', '/opini-sosial/', '/sistem-terbuka/', '/warta-tekno/', '/gaya-hidup/', '/about/', '/privacy/', '/search/', '/security-policy/', '/data-deletion-form/', '/disclaimer/', '/feed/', '/img/', '/lisensi/', '/sitemap/', '/privacy/'].forEach(u => urls.push('${BASE_URL}' + u));
            
            fs.writeFileSync('$SITEMAP_FILE', urls.join('\n') + '\n');
          "
          echo "âœ… sitemap.txt sinkron dengan V6.9"     

  #    - name: 'Generate Screenshots'
  #      run: npm run ci-screenshot

      - name: 7ï¸âƒ£ Inject schema.org (smart mode)
        run: python3 ext/inject_schema.py

      - name: '8ï¸âƒ£ Clean Empty Lines (HTML Minify V6.9)'
        run: |
          echo "ğŸ§¹ Membersihkan baris kosong di folder kategori..."
          # Sekarang kita cari di semua folder kecuali folder sistem
          find . -maxdepth 2 -name "*.html" \
            ! -path "./node_modules/*" \
            ! -path "./.*" \
            ! -path "./artikel/*" \
            ! -path "./artikelx/*" \
            ! -path "./ext/*" \
            ! -path "./sementara/*" \
            ! -path "./mini/*" \
            ! -path "./img/*" \
            ! -name "index.html" \
            -exec sed -i '/^[[:space:]]*$/d' {} +
          echo "âœ… Pembersihan selesai."     

      - name: '9ï¸âƒ£ Commit and Push Generated Files'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "âœ… Tidak ada perubahan file."
          else
            git commit -m "build: ğŸš€ generate site assets (webp mirrors, json, rss, sitemap)"
            git pull --rebase origin main || git pull origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Summary'
        if: always()
        run: |
          echo "âœ… Build & Mirroring selesai"
          echo "ğŸ”— RSS Utama    : https://dalam.web.id/rss.xml"
          echo "ğŸ”— Sitemap XML  : https://dalam.web.id/sitemap.xml"
          echo "ğŸ”— Sitemap TXT  : https://dalam.web.id/sitemap.txt"
          echo "Triggered by: ${{ github.event_name }}"
