name: ‚ò¢Ô∏è Build and Generate Site Files

on:
  workflow_run:
    workflows: ["üîÑ Proses ArtikelX"]
    types: [completed]
    branches: ['main']
  workflow_dispatch:
    inputs:
      run_generator:
        description: 'Jalankan Generator (JSON, RSS, Sitemap XML)'
        type: boolean
        default: true
      run_sitemap_txt:
        description: 'Jalankan Update sitemap.txt'
        type: boolean
        default: true
      run_schema:
        description: 'Jalankan Inject Schema.org'
        type: boolean
        default: true
      run_minify_html:
        description: 'Jalankan HTML Minify'
        type: boolean
        default: true
      run_minify_jsonxml:
        description: 'Jalankan JSONXML Minify'
        type: boolean
        default: true
      run_convert_markdown:
        description: 'Ubah ke format Markdown'
        type: boolean
        default: true  

env:
  DO_GENERATOR: ${{ github.event.inputs.run_generator || 'true' }}
  DO_SITEMAP_TXT: ${{ github.event.inputs.run_sitemap_txt || 'true' }}
  DO_SCHEMA: ${{ github.event.inputs.run_schema || 'true' }}
  DO_MINIFY_HTML: ${{ github.event.inputs.run_minify_html || 'true' }}
  DO_MINIFY_JSONXML: ${{ github.event.inputs.run_minify_jsonxml || 'true' }}
  DO_CONVERT_MARKDOWN : ${{ github.event.inputs.run_convert_markdown || 'true' }}

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 1
          persist-credentials: true      

      - name: '2. Setup Bun.js'
        uses: oven-sh/setup-bun@ab8cb4e8f89912a29b87e4abc4554f2301648a5c
        with:
          bun-version: latest

      - name: '3. Install Dependencies'
        run: bun install --frozen-lockfile

      - name: '4Ô∏è‚É£ Generate artikel.json, Sitemap XML & RSS'
        if: env.DO_GENERATOR == 'true'
        run: bun run ext/generator-pro.js
        env:
          RSS_LIMIT: 30

      - name: '5Ô∏è‚É£ Update sitemap.txt (Native Bun)'
        if: env.DO_SITEMAP_TXT == 'true'
        run: |
          echo "üìù Membuat sitemap.txt (Clean URL)..."
          bun -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('artikel.json', 'utf8'));
            const urls = [];
            const slugify = (t) => t.toLowerCase().trim().replace(/\s+/g, '-');
            const BASE_URL = 'https://dalam.web.id';

            for (const [cat, posts] of Object.entries(data)) {
              const catSlug = slugify(cat);
              posts.forEach(p => {
                const fileSlug = p[1].replace('.html', '').replace(/^\//, '');
                urls.push(BASE_URL + '/' + catSlug + '/' + fileSlug);
              });
            }

            const manualUrls = [
              '', '/jejak-sejarah', '/lainnya', '/olah-media', 
              '/opini-sosial', '/sistem-terbuka', '/warta-tekno', 
              '/gaya-hidup', '/about', '/privacy', '/search', 
              '/security-policy', '/data-deletion-form', '/disclaimer', 
              '/feed', '/img', '/lisensi', '/sitemap'
            ];
            manualUrls.forEach(u => urls.push(BASE_URL + u));

            fs.writeFileSync('sitemap.txt', [...new Set(urls)].join('\n') + '\n');
          "
      
      - name: '6Ô∏è‚É£ Inject SEO Schema'
        if: env.DO_SCHEMA == 'true'
        run: bun run ext/inject-schema.js

      - name: '7Ô∏è‚É£ Convert HTML to Markdown'
        if: env.DO_CONVERT_MARKDOWN == 'true'
        run: bun run ext/html-to-markdown.js
        
      - name: '8Ô∏è‚É£ Minify HTML'
        if: env.DO_MINIFY_HTML == 'true'
        run: bun run ext/minify-html.js

      - name: '9Ô∏è‚É£ Minify Data (JSON & XML)'
        if: env.DO_MINIFY_JSONXML == 'true'
        run: bun run ext/minify-jsonxml.js     

      - name: 'üîü Commit and Push'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "‚úÖ Tidak ada perubahan."
          else
            git commit -m "build: üöÄ optimized site assets (schema, minify, sitemap) [$(date +'%Y-%m-%d %H:%M')]"
            git pull --rebase origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
