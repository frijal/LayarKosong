name: ðŸ“‹ Audit Komponen SEO Lengkap (Layar Kosong Standard)

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout kode
        uses: actions/checkout@v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
      
      - name: Install Dependencies
        run: npm ci

      - name: ðŸ” Audit Komponen Berdasarkan Kelompok
        id: run_audit
        run: |
          TANGGAL=$(date +%Y%m%d)
          REPORT="mini/laporan-audit-$TANGGAL.md"
          
          echo "# ðŸ“ Laporan Audit Komponen Layar Kosong" > $REPORT
          echo "ðŸ“… Diperiksa pada: $(date)" >> $REPORT
          echo "> **Catatan:** Laporan ini dikelompokkan berdasarkan jenis komponen untuk memudahkan perbaikan manual." >> $REPORT

          # Inisialisasi file sementara untuk tiap kategori
          echo -e "\n## ðŸ·ï¸ 1. Core Meta & Branding\n| File | Masalah |\n| :--- | :--- |" > cat1.tmp
          echo -e "\n## ðŸŒ 2. Social Meta & Creators\n| File | Masalah |\n| :--- | :--- |" > cat2.tmp
          echo -e "\n## ðŸ“Š 3. Open Graph & Twitter Card\n| File | Masalah |\n| :--- | :--- |" > cat3.tmp
          echo -e "\n## ðŸ› ï¸ 4. Assets & Schema\n| File | Masalah |\n| :--- | :--- |" > cat4.tmp
          echo -e "\n## ðŸ“ 5. Variasi Description\n| File | Masalah |\n| :--- | :--- |" > cat5.tmp

          FOLDERS="./gaya-hidup ./jejak-sejarah ./lainnya ./olah-media ./opini-sosial ./sistem-terbuka ./warta-tekno"

          for file in $(find $FOLDERS -maxdepth 2 -name "*.html" 2>/dev/null); do
            ERR1=""; ERR2=""; ERR3=""; ERR4=""; ERR5=""
            
            # Fungsi Check per Kategori
            check() {
              if ! grep -q "$1" "$file"; then echo "- Missing: $2<br>"; fi
            }

            # 1. Core Meta
            ERR1=$( (check '<link rel="canonical"' "Canonical Tag"; \
                      check '<link rel="icon" href="/favicon.ico">' "Favicon.ico"; \
                      check '<meta name="author" content="Fakhrul Rijal">' "Author"; \
                      check '<meta name="theme-color" content="#00b0ed">' "Theme Color"; \
                      check 'creativecommons.org/publicdomain/zero/1.0/' "CC0 License") | tr -d '\n' )
            
            # 2. Social Meta
            ERR2=$( (check 'fediverse:creator" content="@frijal@mastodon.social"' "Fediverse Creator"; \
                      check 'twitter:creator" content="@responaja"' "Twitter Creator"; \
                      check 'bluesky:creator" content="@dalam.web.id"' "Bluesky Creator") | tr -d '\n' )

            # 3. OG & Twitter
            ERR3=$( (check 'og:site_name" content="Layar Kosong"' "OG Site Name"; \
                      check 'og:locale" content="id_ID"' "OG Locale"; \
                      check 'twitter:card" content="summary_large_image"' "Twitter Card"; \
                      check 'fb:app_id" content="175216696195384"' "FB App ID") | tr -d '\n' )

            # 4. Assets & Schema
            ERR4=$( (check 'type="application/rss+xml"' "RSS Feed Link") | tr -d '\n' )
            if ! grep -q 'type="application/ld+json"' "$file"; then ERR4+="- Missing: **Schema JSON-LD**<br>"; fi

            # 5. Descriptions
            ERR5=$( (check 'name="description"' "Meta Description"; \
                      check 'property="og:description"' "OG Description"; \
                      check 'name="twitter:description"' "Twitter Description"; \
                      check 'name="promphint"' "Prompt Hint") | tr -d '\n' )

            # Masukkan ke file sementara jika ada error
            [[ ! -z "$ERR1" ]] && echo "| \`$file\` | $ERR1 |" >> cat1.tmp
            [[ ! -z "$ERR2" ]] && echo "| \`$file\` | $ERR2 |" >> cat2.tmp
            [[ ! -z "$ERR3" ]] && echo "| \`$file\` | $ERR3 |" >> cat3.tmp
            [[ ! -z "$ERR4" ]] && echo "| \`$file\` | $ERR4 |" >> cat4.tmp
            [[ ! -z "$ERR5" ]] && echo "| \`$file\` | $ERR5 |" >> cat5.tmp
          done

          # Gabungkan semua tabel ke laporan utama
          cat cat1.tmp cat2.tmp cat3.tmp cat4.tmp cat5.tmp >> $REPORT
          cat $REPORT >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¾ Simpan Laporan
        if: always()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add mini/*.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– docs: audit SEO terkelompok $(date +'%Y-%m-%d')" && git push)
