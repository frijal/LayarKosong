name: üìã Audit Komponen SEO Lengkap (Layar Kosong Standard)

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    # Memberikan izin untuk menulis (write) kembali ke repositori
    permissions:
      contents: write

    steps:
      - name: Checkout kode
        uses: actions/checkout@v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
      
      - name: Install Dependencies
        run: npm ci

      - name: üîç Audit Komponen & Metadata
        id: run_audit
        run: |
          mkdir -p mini
          TANGGAL=$(date +%Y%m%d)
          REPORT="mini/laporan-audit-$TANGGAL.md"
          
          echo "# üìù Laporan Audit Komponen Layar Kosong" > $REPORT
          echo "üìÖ Diperiksa pada: $(date)" >> $REPORT
          echo "> **Catatan:** Workflow ini bersifat Read-Only (hanya memeriksa). Silakan periksa tabel di bawah untuk perbaikan manual." >> $REPORT
          echo "" >> $REPORT
          echo "| File | Status | Detail Komponen Bermasalah |" >> $REPORT
          echo "| :--- | :---: | :--- |" >> $REPORT

          ADA_MASALAH=0
          FOLDERS="./gaya-hidup ./jejak-sejarah ./lainnya ./olah-media ./opini-sosial ./sistem-terbuka ./warta-tekno"

          for file in $(find $FOLDERS -maxdepth 2 -name "*.html" 2>/dev/null); do
            MASALAH_FILE=0
            TEMP_MSG=""
            
            check_tag() {
              if ! grep -q "$1" "$file"; then
                TEMP_MSG+="- Missing: $2<br>"
                MASALAH_FILE=1
                ADA_MASALAH=1
              fi
            }

            # 1. Core Meta & Branding
            check_tag '<link rel="canonical"' "Canonical Tag"
            check_tag '<link rel="icon" href="/favicon.ico">' "Favicon.ico"
            check_tag '<meta name="author" content="Fakhrul Rijal">' "Author"
            check_tag '<meta name="theme-color" content="#00b0ed">' "Theme Color"
            check_tag 'creativecommons.org/publicdomain/zero/1.0/' "CC0 License"

            # 2. Social Meta & Creators
            check_tag 'fediverse:creator" content="@frijal@mastodon.social"' "Fediverse Creator"
            check_tag 'twitter:creator" content="@responaja"' "Twitter Creator"
            check_tag 'bluesky:creator" content="@dalam.web.id"' "Bluesky Creator"

            # 3. Open Graph & Twitter Card
            check_tag 'og:site_name" content="Layar Kosong"' "OG Site Name"
            check_tag 'og:locale" content="id_ID"' "OG Locale"
            check_tag 'twitter:card" content="summary_large_image"' "Twitter Card"
            check_tag 'fb:app_id" content="175216696195384"' "FB App ID"

            # 4. Assets & Schema
            check_tag 'type="application/rss+xml"' "RSS Feed Link"
            if ! grep -q 'type="application/ld+json"' "$file"; then
              TEMP_MSG+="- ‚ùå **SCHEMA JSON-LD TIDAK DITEMUKAN**<br>"
              MASALAH_FILE=1; ADA_MASALAH=1
            fi

            # 5. Variasi Description
            check_tag 'name="description"' "Meta Description"
            check_tag 'property="og:description"' "OG Description"
            check_tag 'name="twitter:description"' "Twitter Description"
            check_tag 'name="promphint"' "Prompt Hint"

            if [ "$MASALAH_FILE" -eq 1 ]; then
              echo "| \`$file\` | ‚ö†Ô∏è Perlu Cek | $TEMP_MSG |" >> $REPORT
            fi
          done

          if [ "$ADA_MASALAH" -eq 0 ]; then
             echo "| Semua file | ‚úÖ Aman | Komponen lengkap sesuai standar. |" >> $REPORT
          fi
          
          # Kirim ke Summary
          cat $REPORT >> $GITHUB_STEP_SUMMARY

      - name: üßº Linting HTML (HTMLHint)
        if: always()
        run: |
          echo -e "\n## üßº Struktur Kode (HTMLHint)\n" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          npm run lint >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Linting selesai." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: üíæ Simpan Laporan ke Repositori
        if: always()
        run: |
          git config --local user.email "frijal@gmail.com"
          git config --local user.name "Layar Kosong Bot"
          git add mini/*.md
          # Hanya commit jika ada perubahan file agar tidak error
          git diff --quiet && git diff --staged --quiet || (git commit -m "ü§ñ docs: update laporan audit SEO $(date +'%Y-%m-%d')" && git push)

      - name: ‚úÖ Selesai
        run: echo "Audit rampung! Cek folder 'mini/' untuk file laporannya."
