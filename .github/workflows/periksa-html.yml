name: üìã Audit Komponen SEO Lengkap (Layar Kosong Standard)

on:  
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kode
        uses: actions/checkout@v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
      
      - name: Install Dependencies
        run: npm ci

      - name: üîç Audit Komponen & Metadata
        id: run_audit
        run: |
          TANGGAL=$(date +%Y%m%d)
          REPORT="mini/laporan-audit-$TANGGAL.md"
          
          echo "# üìù Laporan Audit Komponen Layar Kosong" > $REPORT
          echo "üìÖ Tanggal: $(date)" >> $REPORT
          echo "" >> $REPORT
          echo "| File | Status | Detail Komponen Bermasalah |" >> $REPORT
          echo "| :--- | :---: | :--- |" >> $REPORT

          ADA_MASALAH=0
          FOLDERS="./gaya-hidup ./jejak-sejarah ./lainnya ./olah-media ./opini-sosial ./sistem-terbuka ./warta-tekno"

          for file in $(find $FOLDERS -maxdepth 2 -name "*.html" 2>/dev/null); do
            MASALAH_FILE=0
            TEMP_MSG=""
            
            check_tag() {
              if ! grep -q "$1" "$file"; then
                TEMP_MSG+="- Missing: $2<br>"
                MASALAH_FILE=1
                ADA_MASALAH=1
              fi
            }

            # 1. Core Meta & Branding
            check_tag '<link rel="canonical"' "Canonical Tag"
            check_tag '<link rel="icon" href="/favicon.ico">' "Favicon.ico"
            check_tag '<meta name="author" content="Fakhrul Rijal">' "Author (Fakhrul Rijal)"
            check_tag '<meta name="theme-color" content="#00b0ed">' "Theme Color (#00b0ed)"
            check_tag 'creativecommons.org/publicdomain/zero/1.0/' "CC0 License"

            # 2. Social Meta (Creators)
            check_tag 'fediverse:creator" content="@frijal@mastodon.social"' "Fediverse Creator"
            check_tag 'twitter:creator" content="@responaja"' "Twitter Creator"
            check_tag 'bluesky:creator" content="@dalam.web.id"' "Bluesky Creator"

            # 3. Open Graph & Twitter Card
            check_tag 'og:site_name" content="Layar Kosong"' "OG Site Name"
            check_tag 'og:locale" content="id_ID"' "OG Locale"
            check_tag 'twitter:card" content="summary_large_image"' "Twitter Card Large"
            check_tag 'fb:app_id" content="175216696195384"' "FB App ID"

            # 4. Assets & Feed
            check_tag 'type="application/rss+xml"' "RSS Feed Link"

            # 5. Schema JSON-LD (Penting!)
            if ! grep -q 'type="application/ld+json"' "$file"; then
              TEMP_MSG+="- ‚ùå **SCHEMA JSON-LD TIDAK DITEMUKAN**<br>"
              MASALAH_FILE=1; ADA_MASALAH=1
            fi

            # 6. Variasi Description (Sesuai contoh kamu)
            check_tag 'name="description"' "Meta Description"
            check_tag 'property="og:description"' "OG Description"
            check_tag 'name="twitter:description"' "Twitter Description"
            check_tag 'name="promphint"' "Prompt Hint Meta"

            # Masukkan ke tabel jika ada yang bolong
            if [ "$MASALAH_FILE" -eq 1 ]; then
              echo "| \`$file\` | ‚ùå | $TEMP_MSG |" >> $REPORT
            fi
          done

          if [ "$ADA_MASALAH" -eq 0 ]; then
             echo "| Semua file | ‚úÖ | Komponen lengkap sesuai standar. |" >> $REPORT
          fi

          if [ "$ADA_MASALAH" -eq 1 ]; then echo "ada_error=true" >> $GITHUB_ENV; fi
          cat $REPORT >> $GITHUB_STEP_SUMMARY

      - name: üßº Linting HTML (HTMLHint)
        if: always()
        run: |
          echo -e "\n## üßº Struktur Kode (HTMLHint)\n" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          npm run lint >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Ada peringatan struktur." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: üö® Kesimpulan
        if: env.ada_error == 'true'
        run: |
          echo "Beberapa artikel belum memenuhi standar komponen Layar Kosong."
          exit 1
