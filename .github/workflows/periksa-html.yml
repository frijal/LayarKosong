name: üìã Validasi SEO & Struktur HTML Lengkap

on:  
  workflow_dispatch:

jobs:
  validasi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kode
        uses: actions/checkout@v6.0.2

      - name: Cache Node Modules
        uses: actions/cache@v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24
      
      - name: Install Dependencies
        run: npm ci

      - name: Validasi HTML & SEO (Hanya Folder Kategori)
        run: |
          TANGGAL=$(date +%Y%m%d)
          TXT="mini/laporan-validasi-$TANGGAL.txt"
          JSON="mini/laporan-validasi-$TANGGAL.json"
          echo "üìã Laporan Validasi HTML & SEO" > $TXT
          echo "[" > $JSON

          FIRST=1
          
          # Tentukan folder kategori kamu di sini (pisahkan dengan spasi)
          # Contoh: ./blog ./artikel ./tutorial
          FOLDERS="./artikel ./kategori ./blog"

          # Kita gunakan find hanya pada folder-folder tersebut
          for file in $(find $FOLDERS -maxdepth 2 -name "*.html" 2>/dev/null); do
            GAGAL=0
            TEMP=""
            JSON_ENTRY="{\"file\":\"$file\",\"issues\":["

            # Metadata SEO
            check() {
              if ! grep -q "$1" "$file"; then
                TEMP+="‚ùå $2 MISSING\n"
                JSON_ENTRY="$JSON_ENTRY\"$2 missing\","
                GAGAL=1
              fi
            }

            check '<meta name="description"' "description"
            check '<meta property="og:title"' "og:title"
            check '<meta property="og:image"' "og:image"
            check '<meta property="og:description"' "og:description"
            check '<meta name="twitter:title"' "twitter:title"
            check '<meta name="twitter:image"' "twitter:image"
            check '<meta name="twitter:description"' "twitter:description"
            check '<link rel="canonical"' "canonical"

            # Struktur HTML
            check '<html lang=' "html lang"
            check '<meta charset=' "meta charset"
            check '<title>' "title"
            check '<head>' "head"
            check '<body>' "body"
            check '<main>' "main"
            check '<footer>' "footer"

            # Heading
            H1_COUNT=$(grep -o '<h1>' "$file" | wc -l)
            if [ "$H1_COUNT" -eq 0 ]; then
              TEMP+="‚ùå <h1> tidak ditemukan\n"
              JSON_ENTRY="$JSON_ENTRY\"h1 missing\","
              GAGAL=1
            elif [ "$H1_COUNT" -gt 1 ]; then
              TEMP+="‚ö†Ô∏è Duplikat <h1> ditemukan ($H1_COUNT)\n"
              JSON_ENTRY="$JSON_ENTRY\"multiple h1 ($H1_COUNT)\","
              GAGAL=1
            fi

            HEADINGS=$(grep -o '<h[1-6]>' "$file" | sed 's/<h\([1-6]\)>/\1/' | paste -sd " " -)
            if echo "$HEADINGS" | grep -qE '(^| )1( |$).*[^2]( |$)'; then
              TEMP+="‚ö†Ô∏è Urutan heading mungkin melompat: $HEADINGS\n"
              JSON_ENTRY="$JSON_ENTRY\"heading jump: $HEADINGS\","
              GAGAL=1
            fi

            # Jika gagal, tulis ke laporan
            if [ "$GAGAL" -eq 1 ]; then
              echo "‚û°Ô∏è File: $file" >> $TXT
              echo -e "$TEMP" >> $TXT
              echo "----------------------------------------" >> $TXT

              JSON_ENTRY="${JSON_ENTRY%?}]}" # tutup array dan object
              if [ "$FIRST" -eq 1 ]; then
                echo "$JSON_ENTRY" >> $JSON
                FIRST=0
              else
                echo ",$JSON_ENTRY" >> $JSON
              fi
            fi
          done

          echo "]" >> $JSON

      - name: Run Auto-Fix SEO
        run: npm run fixseo || echo "ada_error=true" >> $GITHUB_ENV

      - name: Linting HTML
        run: |
          TANGGAL=$(date +%Y%m%d)
          TXT="mini/laporan-validasi-$TANGGAL.txt"
          echo "üßº Linting HTML dengan HTMLHint..." >> $TXT
          npm run lint >> $TXT || echo "‚ö†Ô∏è Ada peringatan dari HTMLHint." >> $TXT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ü§ñ chore: auto-fix SEO & Audit Struktur"
          branch: auto-fix-seo-bot
          title: "üìù Perbaikan SEO & Audit Struktur"
          body: |
            Halo @frijal! ü§ñ
            
            Saya baru saja memeriksa artikel kamu. 
            - Jika ada kesalahan struktur (tag tidak seimbang), silakan cek tab **"Files changed"** atau **"Checks"**. Saya sudah memberikan komentar di baris yang bermasalah.
            - Jika aman, saya sudah melakukan auto-fix untuk SEO, Image Alt, dan Script Defer.
          labels: automated-pr

      # Jika tadi ada error, kita buat workflow ini gagal di akhir supaya muncul tanda silang merah
      - name: Check for errors
        if: env.ada_error == 'true'
        run: |
          echo "Audit menemukan kesalahan struktur pada HTML. Silakan periksa komentar di PR."
          exit 1
