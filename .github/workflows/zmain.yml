name: Purge All GitHub Discussions

on:
  workflow_dispatch:

jobs:
  purge:
    runs-on: ubuntu-latest

    steps:
      - name: Delete all discussions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: frijal
          REPO: LayarKosong
        run: |
          set -e

          echo "Fetching repository node ID..."
          REPO_ID=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"query {
                repository(owner: \\\"$OWNER\\\", name: \\\"$REPO\\\") {
                  id
                }
              }\"
            }" | jq -r '.data.repository.id')

          echo "Repo ID: $REPO_ID"

          echo "Fetching discussions..."
          DISCUSSION_IDS=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"query {
                repository(id: \\\"$REPO_ID\\\") {
                  discussions(first: 100) {
                    nodes {
                      id
                      title
                    }
                  }
                }
              }\"
            }" | jq -r '.data.repository.discussions.nodes[].id')

          if [ -z \"$DISCUSSION_IDS\" ]; then
            echo \"No discussions found.\"
            exit 0
          fi

          for ID in $DISCUSSION_IDS; do
            echo \"Deleting discussion $ID\"
            curl -s -X POST https://api.github.com/graphql \
              -H \"Authorization: Bearer $GH_TOKEN\" \
              -H \"Content-Type: application/json\" \
              -d \"{
                \\\"query\\\": \\\"mutation {
                  deleteDiscussion(input:{id:\\\\\\\"$ID\\\\\\\"}) {
                    clientMutationId
                  }
                }\\\"
              }\"
          done

          echo \"All discussions deleted.\"
