name: Fix punycode deprecation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1' # weekly check every Monday 03:00 UTC

jobs:
  detect-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Node Modules
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies (clean)
        run: npm ci

      - name: Capture deprecation traces (non-failing)
        run: |
          # Ganti ENTRY_POINT jika repo Anda punya entry point lain, mis. "src/index.js"
          ENTRY_POINT=${ENTRY_POINT:-index}
          node --trace-deprecation -e "try { require('./'$ENTRY_POINT''); } catch(e) { /* ignore runtime errors */ }" 2>&1 | tee deprecation-trace.txt || true
        env:
          CI: true

      - name: Upload deprecation trace
        uses: actions/upload-artifact@v6
        with:
          name: deprecation-trace
          path: deprecation-trace.txt

      - name: Try automatic dependency updates (non-failing)
        run: |
          npm update || true
          npm audit fix --force || true

      - name: Ensure userland punycode is available (idempotent)
        run: |
          npm install --save-dev punycode@latest
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Commit only if package files changed
          if git status --porcelain | grep -qE 'package(-lock)?\.json'; then
            git add package.json package-lock.json || true
            git commit -m "chore(ci): add punycode devDependency to address DEP0040" || true
          else
            echo "No package changes to commit."
          fi

      - name: Check for package changes
        id: check_changes
        run: |
          if git status --porcelain | grep -qE 'package(-lock)?\.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests if script exists
        run: |
          if node -e "try { const p = require('./package.json'); process.exit(p.scripts && p.scripts.test ? 0 : 1); } catch(e) { process.exit(1); }"; then
            echo "Found test script, running npm test..."
            npm test
          else
            echo "No test script found, skipping npm test."
          fi
        env:
          CI: true

      - name: Create PR if package files changed
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ci: update deps and add punycode to address DEP0040"
          branch: fix/punycode-deprecation
          title: "Fix: punycode deprecation (automated)"
          body: |
            This PR updates dependencies and adds the userland punycode package as a temporary fix for DEP0040.
            Please prefer upstream dependency updates that remove usage of Node's deprecated punycode module.
