name: Sitemap XML Fixer and Diagnostics

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  sitemap-fix-and-diagnose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install required packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libxml2-utils sed grep

      - name: ðŸ›  STEP 1 - Auto-Fix Common XML Errors
        run: |
          FILE="sitemap.xml"
          if [ -f "$FILE" ]; then
            echo "Memperbaiki karakter ampersand ilegal menggunakan Perl..."
            # Perl mendukung negative lookahead (?!...) dengan sempurna
            perl -i -pe 's/&(?!(amp|lt|gt|quot|apos|#\d+|#x[0-9a-fA-F]+);)/&amp;/g' "$FILE"
            
            echo "Menghapus karakter kontrol non-printable..."
            # Menggunakan perl untuk menghapus karakter kontrol agar lebih konsisten
            perl -i -pe 's/[\x00-\x08\x0B\x0C\x0E-\x1F]//g' "$FILE"
            
            echo "Memastikan file menggunakan UTF-8 tanpa BOM..."
            # Menghapus Byte Order Mark (BOM) jika ada
            perl -i -pe 's/^\xEF\xBB\xBF//' "$FILE"
            
            echo "Selesai memperbaiki $FILE"
          else
            echo "File $FILE tidak ditemukan, melewati langkah ini."
          fi

      - name: ðŸ” STEP 2 - Validate Schema Video & Images
        run: |
          OUTDIR="${{ github.workspace }}/debug-gsc"
          mkdir -p "$OUTDIR"
          
          echo "=== Laporan Validasi Video ===" > "$OUTDIR/video-report.txt"
          
          # Cek apakah tag video:thumbnail_loc ada dan memiliki format gambar yang benar
          grep -oP '(?<=<video:thumbnail_loc>)[^<]+' sitemap.xml > "$OUTDIR/thumbnails.txt" || true
          if [ -s "$OUTDIR/thumbnails.txt" ]; then
             while read -r thumb; do
               if [[ ! "$thumb" =~ \.(jpg|jpeg|png|webp)$ ]]; then
                 echo "PERINGATAN: Format thumbnail tidak standar: $thumb" >> "$OUTDIR/video-report.txt"
               fi
             done < "$OUTDIR/thumbnails.txt"
          fi

      - name: ðŸŒ STEP 3 - Deep Link & Thumbnail Checker (Status 200)
        run: |
          OUTDIR="${{ github.workspace }}/debug-gsc"
          echo "=== HTTP Status Check (Limit 50 URLs) ===" >> "$OUTDIR/video-report.txt"
          
          # Ambil 50 URL pertama untuk dicek statusnya (menghindari rate limit)
          grep -oP '(?<=<loc>)[^<]+' sitemap.xml | head -n 50 > "$OUTDIR/urls-to-check.txt"
          while read -r url; do
            status=$(curl -o /dev/null -s -w "%{http_code}" -L --max-time 10 "$url")
            if [ "$status" != "200" ]; then
              echo "ERROR $status: $url" >> "$OUTDIR/video-report.txt"
            fi
          done < "$OUTDIR/urls-to-check.txt"

      - name: ðŸš€ STEP 4 - Commit Fixes and Reports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add sitemap.xml debug-gsc/
          if git diff --cached --quiet; then
            echo "Tidak ada perubahan yang perlu di-commit."
          else
            git commit -m "Fix: Auto-repair sitemap.xml & update GSC debug report"
            git push
          fi
