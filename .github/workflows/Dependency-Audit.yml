- name: Upgrade & Sync to @google/genai (Latest)
        run: |
          echo "Upgrading to the latest Generative AI SDK..."
          
          if [ -f package.json ]; then
            # 1. Hapus paket lama dan install yang baru (@google/genai)
            npm uninstall @google/generative-ai
            npm install @google/genai node-fetch playwright
            
            # 2. Pastikan semua kode di folder ext/ pakai import yang benar
            # Kita arahkan semua agar panggil @google/genai
            find ext/ -type f -name "*.js" -exec sed -i 's/@google\/generative-ai/@google\/genai/g' {} +
          fi

      - name: Audit & Check Unused Node.js Packages
        run: |
          DATE=$(date +'%Y-%m-%d')
          if [ -f package.json ]; then
            echo "--- Unused Dependencies (via depcheck) ---" > audit/npm_unused_$DATE.txt
            # Sekarang depcheck harusnya happy karena nama di kode & package.json sudah sinkron
            npx depcheck . --json=false --skip-missing=true >> audit/npm_unused_$DATE.txt || true
          fi
