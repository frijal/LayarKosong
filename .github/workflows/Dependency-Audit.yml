name: ðŸ•µï¸ Audit Repo & Paket Berat

on:
  workflow_dispatch: # Kita jalankan manual aja biar gak spamming tiap push

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Buat Folder Output
        run: mkdir -p sementara/audit

      # 1. CEK FISIK (Disk Usage)
      # Ini buat nyari tau folder mana yang ukurannya raksasa
      - name: ðŸ’¾ Cek Ukuran Folder (Top 20 Terbesar)
        run: |
          echo "=== TOP 20 FOLDER TERBESAR ===" > sementara/audit/laporan-disk.txt
          echo "Dihitung pada: $(date)" >> sementara/audit/laporan-disk.txt
          echo "-----------------------------------" >> sementara/audit/laporan-disk.txt
          # du -h untuk human readable, sort -hr untuk urutkan dari terbesar
          du -h . --max-depth=3 --exclude=.git | sort -hr | head -n 20 >> sementara/audit/laporan-disk.txt
          cat sementara/audit/laporan-disk.txt

      # 2. AUDIT NODE.JS (Jika pakai JS/TS)
      - name: ðŸ“¦ Setup Node (Jika ada package.json)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ•µï¸ Audit NPM (List & Unused)
        if: hashFiles('package.json') != ''
        run: |
          echo "Menginstall dependencies..."
          npm install --force # Install dulu biar bisa diaudit
          
          echo "=== SEMUA PAKET TERPASANG ===" > sementara/audit/npm-installed.txt
          npm list --all --depth=0 >> sementara/audit/npm-installed.txt
          
          echo "=== MENCARI PAKET TIDAK TERPAKAI (DEPCHECK) ===" > sementara/audit/npm-unused.txt
          # Menggunakan npx depcheck tanpa install global
          # Tool ini sakti buat nyari bloatware di JS
          npx depcheck >> sementara/audit/npm-unused.txt || true

      # 3. AUDIT PYTHON (Jika pakai Python)
      - name: ðŸ Audit Python (Jika ada requirements.txt)
        if: hashFiles('requirements.txt') != ''
        run: |
          pip install -r requirements.txt
          echo "=== PAKET PYTHON TERPASANG ===" > sementara/audit/python-installed.txt
          pip freeze >> sementara/audit/python-installed.txt

      # 4. UPLOAD HASIL
      # Karena ini jalan di cloud (runner), kita harus download hasilnya
      - name: ðŸ“¤ Upload Hasil Audit
        uses: actions/upload-artifact@v4
        with:
          name: laporan-audit-repo
          path: sementara/audit/
