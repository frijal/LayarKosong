name: "ğŸŸ¢ Layar Kosong: Super Automation & MedSos"

on:
  schedule:
    - cron: "0 */4 * * *" # Eksekusi otomatis tiap 2 jam
  workflow_dispatch:
    inputs:
      task:
        description: 'Pilih tugas yang ingin dijalankan'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - diskusi RSS
          - cloudflare
          - bluesky
          - discord
          - facebook
          - linkedin
          - mastodon
          - threads
          - tumblr
          - indexnow
          - llms_index

permissions:
  contents: write
  discussions: write
  issues: write # Dibutuhkan oleh Octokit untuk membuat label baru
  
jobs:
  everything-job:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Checkout Repository
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: true

      # --- 1. LOGIKA PILIH BAHASA (Kuncinya di sini) ---
      - name: ğŸ¯ Check Requirements
        id: check
        run: |
          TASK="${{ inputs.task }}"
          # Default: jalankan semua kalau schedule atau inputnya 'all'
          NEED_NODE=true
          NEED_PYTHON=true

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "$TASK" != "all" ]]; then
            # Daftar task khusus Node.js
            NODE_ONLY=("diskusi RSS" "cloudflare" "discord" "mastodon" "threads" "linkedin" "tumblr")
            # Daftar task khusus Python/Bash
            PYTHON_ONLY=("bluesky" "indexnow" "patreon" "llms_index" "facebook")

            if [[ " ${NODE_ONLY[@]} " =~ " $TASK " ]]; then
               NEED_PYTHON=false
               echo "â„¹ï¸ Task '$TASK' terdeteksi hanya butuh Node.js. Skip Python."
            elif [[ " ${PYTHON_ONLY[@]} " =~ " $TASK " ]]; then
               NEED_NODE=false
               echo "â„¹ï¸ Task '$TASK' terdeteksi hanya butuh Python. Skip Node.js."
            fi
          fi
          
          echo "need_node=$NEED_NODE" >> $GITHUB_OUTPUT
          echo "need_python=$NEED_PYTHON" >> $GITHUB_OUTPUT

      # --- 2. SETUP NODE.JS (Hanya jika need_node=true) ---
      - name: ğŸ—ï¸ Setup Node.js
        if: steps.check.outputs.need_node == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: ğŸ“¦ Install Node Dependencies
        if: steps.check.outputs.need_node == 'true'
        run: npm ci

      # --- 3. SETUP PYTHON (Hanya jika need_python=true) ---
      - name: ğŸ—ï¸ Setup Python
        if: steps.check.outputs.need_python == 'true'
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: ğŸ“¦ Install Python Dependencies
        if: steps.check.outputs.need_python == 'true'
        run: pip install -r mini/requirements.txt

      # =========================================================
      # ğŸŸ¢ BAGIAN 1: NODE.JS SCRIPTS (.js)
      # =========================================================

      - name: RSS kirim ke Diskusi Github
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'diskusi RSS'
        continue-on-error: true
        env:
        # Token rahasia bawaan GitHub untuk autentikasi API
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node ext/bikin-rss-diskusi.js

      - name: ğŸ§¹ 1. Cloudflare Cleanup
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'cloudflare'
        continue-on-error: true
        env:
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_PROJECT_NAME: ${{ secrets.CF_PROJECT_NAME }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: node ext/rapikan-cloudflare.js

      - name: ğŸ˜ 2. Mastodon Autopost
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'mastodon'
        continue-on-error: true
        env:
          MASTODON_INSTANCE: mastodon.social
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
        run: node ext/post-to-mastodon.js

      - name: âš™ï¸ 3. Threads Post Script
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'threads'
        continue-on-error: true
        env:
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}
        run: node ext/post-to-threads.js     

      - name: ğŸ†• 4. LinkedIn Post Script
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'linkedin'
        continue-on-error: true
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_ID: ${{ secrets.LINKEDIN_PERSON_ID }}
        run: node ext/post-to-linkedin.js

      - name: ğŸ¨ 5. Tumblr Autopost
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'tumblr'
        continue-on-error: true
        env:
          TUMBLR_CONSUMER_KEY: ${{ secrets.TUMBLR_CONSUMER_KEY }}
          TUMBLR_CONSUMER_SECRET: ${{ secrets.TUMBLR_CONSUMER_SECRET }}
          TUMBLR_TOKEN: ${{ secrets.TUMBLR_TOKEN }}
          TUMBLR_TOKEN_SECRET: ${{ secrets.TUMBLR_TOKEN_SECRET }}
        run: node ext/post-to-tumblr.js

      - name: ğŸ¦‹ 6. Discord Feed
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'discord'
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: node ext/post-to-discord.js

      # =========================================================
      # ğŸŸ¡ BAGIAN 2: PYTHON & BASH SCRIPTS
      # =========================================================

  #    - name: ğŸ¦‹ 6. Bluesky Autopost
  #      if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'bluesky'
  #      continue-on-error: true
  #      env:
  #        BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
  #        BSKY_PASSWORD: ${{ secrets.BSKY_PASSWORD }}
  #      run: |
  #        python3 ext/post-to-bluesky.py
  #        if [ -f /tmp/temp_new_url_bsky.txt ]; then
  #          cat /tmp/temp_new_url_bsky.txt >> mini/posted-bluesky.txt
  #        fi      

      - name: âš™ï¸ 7. Generate LLMs Index
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'llms_index'
        continue-on-error: true
        run: |
          if [ -f ext/generate_llms.py ]; then
            python3 ext/generate_llms.py
          fi

      - name: ğŸ”µ 8. Process Facebook (Data Prep)
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'facebook'
        id: fb_info
        continue-on-error: true
        run: python3 ext/post-to-facebook.py

      - name: ğŸš€ 9. Send to Facebook Page
        if: (github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'facebook') && steps.fb_info.outputs.url != '' && steps.fb_info.outputs.url != null
        continue-on-error: true
        run: |
          curl -X POST "https://graph.facebook.com/v24.0/${{ secrets.FB_PAGE_ID }}/feed" \
            -d "message=${{ steps.fb_info.outputs.encoded_msg }}" \
            -d "link=${{ steps.fb_info.outputs.url }}" \
            -d "access_token=${{ secrets.FB_PAGE_TOKEN }}"
          
          if [ -f /tmp/temp_new_url_facebook.txt ]; then
            cat /tmp/temp_new_url_facebook.txt >> mini/posted-facebook.txt
          fi

      - name: ğŸ” 10. IndexNow Sync (Bash & JQ)
        if: github.event_name == 'schedule' || inputs.task == 'all' || inputs.task == 'indexnow'
        continue-on-error: true
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          touch mini/indexnow-cache.txt
          grep -v -F -x -f mini/indexnow-cache.txt sitemap.txt > /tmp/new_urls.txt || true
          if [ -s /tmp/new_urls.txt ]; then
            jq -n --arg host "dalam.web.id" --arg key "$INDEXNOW_KEY" --argjson urls "$(jq -R . < /tmp/new_urls.txt | jq -s .)" '{host: $host, key: $key, urlList: $urls}' > /tmp/payload.json
            curl -X POST "https://bing.com/indexnow" -H "Content-Type: application/json; charset=utf-8" --data-binary @/tmp/payload.json --fail
            cat /tmp/new_urls.txt >> mini/indexnow-cache.txt
          fi

      # =========================================================
      # ğŸ’¾ BAGIAN 3: FINAL COMMIT
      # =========================================================
      
      - name: ğŸ’¾ Save All Changes (Universal Template)
        run: |
          # 1. Identitas Bot
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2. Ambil semua perubahan tanpa pilih kasih
          git add . 
          
          # 3. Cek apakah benar-benar ada yang berubah
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Ga ada kerjaan baru, skip commit."
          else
            # 4. Commit dengan timestamp biar rapi di history
            git commit -m "chore: automation MedSos Post [$(date +'%Y-%m-%d %H:%M')]"
            
            # 5. Tarik data terbaru dengan aman (kunci suksesnya di sini)
            git pull origin main --rebase --autostash
            
            # 6. Gas pol push ke repo
            git push
          fi
