name: Renovate Immutable Self-Contained

on:
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * *' # Tepat 18.00 WITA

permissions:
  contents: write

jobs:
  renovate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - uses: actions/checkout@v6

      # 2Ô∏è‚É£ Prepare folder sementara/ di root project
      - name: Prepare folder for artifact
        run: |
          mkdir -p sementara
          chmod 777 sementara

      # 3Ô∏è‚É£ Pull image & hitung hash
      - name: Pull latest Renovate image
        run: |
          docker pull ghcr.io/renovatebot/renovate:full
          IMAGE_HASH=$(docker images --no-trunc --quiet ghcr.io/renovatebot/renovate:full | cut -d: -f2 | cut -c1-12)
          echo "IMAGE_HASH=$IMAGE_HASH" >> $GITHUB_ENV
          # Nama file tetap pakai prefix renovate-cache- sesuai preferensimu
          ARTIFACT_NAME="renovate-cache-${IMAGE_HASH}"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
          echo "TAR_PATH=sementara/$ARTIFACT_NAME.tar" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Download artifact jika ada (mencoba restore)
      - name: Download Docker image artifact if exists
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: sementara
        continue-on-error: true

      # 5Ô∏è‚É£ Load dari folder sementara/ jika filenya ada
      - name: Load Renovate Docker image
        run: |
          if [ -f "${{ env.TAR_PATH }}" ]; then
            echo "‚úÖ Loading Docker image from local folder sementara/..."
            docker load -i "${{ env.TAR_PATH }}"
          else
            echo "‚ö†Ô∏è File .tar tidak ditemukan di folder sementara/, menggunakan pull terbaru."
          fi

      # 6Ô∏è‚É£ Run Renovate (Menggunakan RENOVATE_TOKEN)
      - name: Run Renovate
        uses: renovatebot/github-action@v44.2.6
        with:
          configurationFile: mini/renovate.json5
          token: ${{ secrets.RENOVATE_TOKEN }}
          renovate-version: full
        env:
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_ONBOARDING: "false"
          RENOVATE_REQUIRE_CONFIG: "ignored"
          # Cache path disesuaikan dengan preferensi "renovate-cache-"
          RENOVATE_REPOSITORY_CACHE: /tmp/renovate-cache-inline

      # 7Ô∏è‚É£ Save image ke folder sementara/ untuk siklus berikutnya
      - name: Save Docker image to local folder
        run: |
          docker save ghcr.io/renovatebot/renovate:full -o "${{ env.TAR_PATH }}"
          ls -lh sementara/

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.TAR_PATH }}
          retention-days: 1 # Biar gak menuhin storage karena tiap hari ganti

      # 8Ô∏è‚É£ Cleanup old tar files in local folder
      - name: Cleanup old local files
        run: |
          find sementara -name "renovate-cache-*.tar" ! -name "${{ env.ARTIFACT_NAME }}.tar" -delete

      # 9Ô∏è‚É£ Commit & Push (Semua pakai RENOVATE_TOKEN)
      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "‚úÖ Tidak ada perubahan file."
          else
            git commit -m "chore: üöÄ update files via Renovate"
            # Menggunakan RENOVATE_TOKEN untuk push agar konsisten
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
