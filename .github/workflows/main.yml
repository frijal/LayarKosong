name: Patreon API Diagnosis

on:
  workflow_dispatch: # Agar bisa kamu jalankan manual dari tab "Actions"

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: pip install requests

      - name: Run Diagnosis Script
        env:
          PATREON_ACCESS_TOKEN: ${{ secrets.PATREON_ACCESS_TOKEN }}
        run: |
          cat << 'EOF' > debug_patreon.py
          import os
          import requests
          import json

          token = os.getenv('PATREON_ACCESS_TOKEN')

          def diagnose():
              if not token:
                  print("‚ùå ERROR: PATREON_ACCESS_TOKEN kosong!")
                  return

              headers = {
                  "Authorization": f"Bearer {token}",
                  "User-Agent": "Patreon-Diagnoser/1.0"
              }
              
              # 1. Cek Identity & Scopes
              print("\n--- üîç STEP 1: DIAGNOSA TOKEN ---")
              try:
                  user_res = requests.get("https://www.patreon.com/api/oauth2/v2/identity?fields%5Buser%5D=full_name", headers=headers)
                  print(f"Status Identity: {user_res.status_code}")
                  if user_res.status_code == 200:
                      print(f"Data User: {user_res.json().get('data', {}).get('attributes', {}).get('full_name')}")
                  
                  # Mencari Scopes di Header
                  scopes = user_res.headers.get('X-OAuth-Scopes') or user_res.headers.get('X-Accepted-OAuth-Scopes')
                  print(f"Scopes yang terdeteksi di Header: {scopes}")
              except Exception as e:
                  print(f"Gagal di Step 1: {e}")

              # 2. Cek List Campaigns
              print("\n--- üîç STEP 2: CEK AKSES KAMPANYE ---")
              camp_res = requests.get("https://www.patreon.com/api/oauth2/v2/campaigns", headers=headers)
              print(f"GET /v2/campaigns: {camp_res.status_code}")

              # 3. Cek Endpoint Posts (GET)
              print("\n--- üîç STEP 3: TEST AKSES ENDPOINT POSTS ---")
              # Kita tes rute yang tadi kasih 404
              test_url = "https://www.patreon.com/api/oauth2/v2/posts"
              get_res = requests.get(test_url, headers=headers)
              print(f"GET {test_url}: {get_res.status_code}")
              
              if get_res.status_code == 404:
                  print("üí° ANALISA: Rute /v2/posts benar-benar TIDAK ADA untuk token ini.")
              elif get_res.status_code == 401:
                  print("üí° ANALISA: Token tidak valid atau tidak punya izin baca.")
              
          if __name__ == "__main__":
              diagnose()
          EOF
          python3 debug_patreon.py
