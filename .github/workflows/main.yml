name: Renovate Fast

on:
  workflow_dispatch:
  schedule:
    - cron: '0 11 * * *' # 18.00 WITA

jobs:
  renovate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      # 1️⃣ Pastikan folder sementara/ ada
      - name: Prepare folder
        run: mkdir -p ${{ github.workspace }}/sementara

      # 2️⃣ Load Docker image dari artifact atau pull terbaru
      - name: Load Renovate Docker image
        run: |
          TAR_FILE="${{ github.workspace }}/sementara/renovate-full.tar"
          if [ -f "$TAR_FILE" ]; then
            echo "Loading self-contained Renovate Docker image from artifact..."
            docker load -i "$TAR_FILE"
          else
            echo "No artifact found, pulling latest Renovate image..."
            docker pull ghcr.io/renovatebot/renovate:full
          fi

      # 3️⃣ Jalankan Renovate (cache sudah embedded di image)
      - name: Run Renovate
        uses: renovatebot/github-action@v44.2.6
        with:
          configurationFile: mini/renovate.json5
          token: ${{ secrets.GH_PAT }}
          renovate-version: full
        env:
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_ONBOARDING: "false"
          RENOVATE_REQUIRE_CONFIG: "ignored"
          # Path cache di dalam image → tidak perlu folder tambahan
          RENOVATE_REPOSITORY_CACHE: /tmp/renovate-inline-cache

      # 4️⃣ Save Docker image terbaru sebagai artifact (overwrite)
      - name: Save self-contained Docker image to artifact
        run: |
          docker save ghcr.io/renovatebot/renovate:full -o ${{ github.workspace }}/sementara/renovate-full.tar
      - uses: actions/upload-artifact@v6
        with:
          name: renovate-full
          path: ${{ github.workspace }}/sementara/renovate-full.tar
          retention-days: 7
