name: RenovateX Fast

on:
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * *' # 18.00 WITA

permissions:
  contents: write

jobs:
  renovate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4    
      # 1Ô∏è‚É£ Cek SHA Image di server (Tanpa Pull)
      - name: Get Remote Image Digest
        id: check_remote
        run: |
          IMAGE_TAG="full"
          DIGEST=$(docker manifest inspect ghcr.io/renovatebot/renovate:$IMAGE_TAG -v | jq -r 'if type=="array" then .[0].Descriptor.digest else .Descriptor.digest end' | cut -d: -f2 | cut -c1-12)          
          # Prefix sesuai instruksi user: renovate-cache-
          echo "CACHE_KEY=renovate-cache-$DIGEST" >> $GITHUB_ENV
          echo "TAR_PATH=sementara/renovate-image.tar" >> $GITHUB_ENV

      # 2Ô∏è‚É£ Restore dari GitHub Cache
      - name: Restore Docker Image Cache
        id: cache-docker
        uses: actions/cache@v4
        with:
          path: sementara/renovate-image.tar
          key: ${{ env.CACHE_KEY }}

      # 3Ô∏è‚É£ Load atau Pull
      - name: Load or Pull Renovate Image
        run: |
          if [ "${{ steps.cache-docker.outputs.cache-hit }}" == "true" ]; then
            echo "üöÄ Cache ditemukan! Loading image..."
            docker load -i "${{ env.TAR_PATH }}"
          else
            echo "‚ö†Ô∏è Cache miss atau versi baru tersedia. Pulling..."
            docker pull ghcr.io/renovatebot/renovate:full
            docker save ghcr.io/renovatebot/renovate:full -o "${{ env.TAR_PATH }}"
          fi

      # 4Ô∏è‚É£ Jalankan Renovate
      - name: Run Renovate
        uses: renovatebot/github-action@v44.2.6
        with:
          configurationFile: mini/renovate.json5
          token: ${{ secrets.RENOVATE_TOKEN }}
          renovate-version: full
        env:
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_ONBOARDING: "false"
          RENOVATE_REQUIRE_CONFIG: "ignored"
          # Cache metadata Renovate juga menggunakan prefix yang sama
          RENOVATE_REPOSITORY_CACHE: /tmp/renovate-cache-inline

      # 5Ô∏è‚É£ Commit & Push
      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: üöÄ update via RenovateX"
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
