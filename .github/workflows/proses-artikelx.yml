name: ğŸ”„ Proses ArtikelX

on:
  push:
    branches: ['main']
    paths:
      - 'artikelx/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process_and_move_articles:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout repo
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Pastikan Perl tersedia
      - name: ğŸª Setup Perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.36'

      # 3ï¸âƒ£ Jalankan localize-assets.pl untuk ganti CDN â†’ lokal
      - name: ğŸ”§ Ganti CDN ke Lokal
        run: |
          chmod +x ext/gantifontshighlight.pl
          perl ext/gantifontshighlight.pl --quiet --no-backup

      # 4ï¸âƒ£ Ganti konten dasar (meta, domain, icon, dll)
      - name: ğŸª„ Jalankan find-and-replace
        run: |
          shopt -s nullglob
          for file in artikelx/*.html; do
            echo "ğŸª„ Memproses $file"
            perl -pi -w -e 's#</head>#<meta name="google-adsense-account" content="ca-pub-8157928740123992"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8157928740123992" crossorigin="anonymous"></script></head>#g' "$file"
            perl -pi -w -e 's#bak.xo.je#frijal.pages.dev#g' "$file"
            perl -pi -w -e 's#https://frijal.pages.dev/assets/apple-touch-icon.png#https://frijal.pages.dev/ext/icons/apple-touch-icon.png#g' "$file"
            perl -pi -w -e 's#hhttps://frijal.pages.dev/apple-touch-icon.png#https://frijal.pages.dev/ext/icons/apple-touch-icon.png#g' "$file"
            perl -pi -w -e 's#frijal_tw#frijal#g' "$file"
            perl -pi -w -e 's#YOUR_FACEBOOK_APP_ID#1471267430691023#g' "$file"
            perl -pi -w -e 's#nama_twitter_anda#frijal#g' "$file"
            perl -pi -w -e 's#&copy;#ğŸ„¯#g' "$file"
            perl -pi -w -e 's#akun_twitter_kamu#frijal#g' "$file"
            perl -pi -w -e 's/Â©/ğŸ„¯/g' "$file"
          done
          shopt -u nullglob

      # 5ï¸âƒ£ Inject meta via JS (opsional)
      - name: ğŸ§© Inject meta & script tambahan
        run: |
          if [ -f ext/inject-meta.js ]; then
            node ext/inject-meta.js || true
          else
            echo "âš ï¸  Tidak ditemukan ext/inject-meta.js, lewati langkah ini."
          fi

      # 6ï¸âƒ£ Tambahkan CSS, JS, dan elemen tambahan
      - name: ğŸ¨ Tambahkan CSS/JS & elemen tambahan
        run: |
          shopt -s nullglob
          echo "ğŸ§© Menambahkan elemen tambahan ke file HTML..."
          for file in artikelx/*.html; do
            echo "ğŸ”§ Memproses: $file"

            # 1ï¸âƒ£ CSS marquee-url
            if ! grep -q '<link rel="stylesheet" href="/ext/marquee-url.css">' "$file"; then
              sed -i '/<\/head>/i <link rel="stylesheet" href="/ext/marquee-url.css"><link rel="alternate" type="application/rss+xml" title="30 artikel baru bikin." href="https://frijal.pages.dev/rss.xml" />' "$file"
            fi

            # 2ï¸âƒ£ div iposbrowser
            if ! grep -q '<div id="iposbrowser"></div>' "$file"; then
              sed -i '/<\/h1>/a <div id="iposbrowser"></div>' "$file"
            fi

            # 3ï¸âƒ£ floating search
            if ! grep -q 'class="search-floating-container"' "$file"; then
              sed -i '/<\/body>/i <div class="search-floating-container"><input type="text" id="floatingSearchInput" placeholder="cari artikel..." autocomplete="off"><span id="floatingSearchClear" class="clear-button"></span><div id="floatingSearchResults" class="floating-results-container"></div></div>' "$file"
            fi

            # 4ï¸âƒ£ related marquee + JS
            if ! grep -q 'id="related-marquee-section"' "$file"; then
              sed -i '/<\/body>/i <section id="related-marquee-section"><div id="related-marquee-container"></div></section><script defer src="/ext/marquee-url.js"></script>' "$file"
            fi

            # 5ï¸âƒ£ iposbrowser.js
            if ! grep -q '/ext/iposbrowser.js' "$file"; then
              sed -i '/<\/body>/i <script defer src="/ext/iposbrowser.js"></script><script defer src="/ext/markdown.js"></script><script defer src="/ext/disqus.js"></script>' "$file"
            fi
          done
          shopt -u nullglob

      # 7ï¸âƒ£ Pindahkan hasil ke folder artikel/
      - name: ğŸ“‚ Pindahkan ke folder artikel/
        run: |
          mkdir -p artikel
          shopt -s nullglob
          if ls artikelx/*.html >/dev/null 2>&1; then
            mv -f artikelx/*.html artikel/
            echo "ğŸ“¦ File berhasil dipindahkan ke artikel/"
          else
            echo "âš ï¸  Tidak ada file HTML di artikelx/"
          fi
          shopt -u nullglob

      # 8ï¸âƒ£ Commit otomatis hasil akhirnya
      - name: ğŸ’¾ Commit & Push perubahan
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          if git diff --quiet; then
            echo "âœ… Tidak ada perubahan untuk dikomit."
          else
            git add artikelx artikel
            git commit -m "ğŸ”„ Workflow: Proses ArtikelX + Localize Assets"
            git push
            echo "ğŸš€ Perubahan berhasil dikirim."
          fi
