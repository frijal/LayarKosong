name: ðŸ”„ Proses ArtikelX
on:
  push:
    branches: ['main']
    paths:
      - 'artikelx/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process_articles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6 # Update ke v4 biar makin sat-set
        with:
          fetch-depth: 1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      # Menggunakan Smart Cache yang sama dengan workflow sebelah
      - name: Rust Cache Engine
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: "layarkosong-engine" # Kunci harus sama persis!

      - name: Build Rust Tools
        run: cargo build --release --quiet

      - name: 1. Localize Assets (Perl)
        run: |
          set -euo pipefail
          if [[ -f ext/gantifontshighlight.pl ]]; then
            chmod +x ext/gantifontshighlight.pl
            perl ext/gantifontshighlight.pl --quiet --no-backup
          fi

      - name: 2. Sterilize Schema (Rust)
        run: ./target/release/clean-schema artikelx/

      - name: 3. Replace Content (Perl Regex)
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in artikelx/*.html; do
            echo "Applying Regex to $file"
            perl -i -wpe '
              s|https://dalam[.]web[.]id/assets/apple-touch-icon[.]png|https://dalam.web.id/ext/icons/apple-touch-icon.png|g;
              s|https://dalam[.]web[.]id/apple-touch-icon[.]png|https://dalam.web.id/ext/icons/apple-touch-icon.png|g;
              s|&copy;|ðŸ„¯|g;
              s|Font Awesome [56] Free|Font Awesome 7 Free|g;
              s|Dalam\.web\.id|Jaga Data Pribadi Tetap Aman|gi;
              s|far fa-copyright|fa-brands fa-creative-commons-zero|g;
              s|>dalam\.web\.id</a>|>Jaga Data Pribadi Tetap Aman</a>|gi;
              s|Analisis (mendalam\|tajam) ||g;
              s|Panduan mendalam ||g;
              s|Simak ulasan mendalam ||g;
              s|content="(Mengapa\|Simak\|Analisis kritis\|Temukan\|Pelajari) ||g;
              s|Â©|ðŸ„¯|g;
              s| - Layar Kosong||g;
            ' "$file"
          done

      - name: 4. Inject SEO, Mirror Images & WebP (Rust)
        run: ./target/release/seo-fixer artikelx

      - name: 5. Add HTML Elements (Rust Engine)
        run: ./target/release/inject-elements artikelx/

      - name: 6. Move to artikel/
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(artikelx/*.html)
          if [[ ${#files[@]} -gt 0 ]]; then
            mv -f "${files[@]}" artikel/
            echo "Pindah ${#files[@]} file ke artikel/"
          else
            echo "Folder artikelx/ kosong."
          fi

      - name: 7. Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add .
          if git diff --staged --quiet; then
            echo "Tidak ada perubahan."
          else
            git commit -m "build(artikelx): move, mirror & webp optimization via rust"
            git push origin main
          fi
