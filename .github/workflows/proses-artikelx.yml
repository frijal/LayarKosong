name: ðŸ”„ Proses ArtikelX

on:
  push:
    branches: ['main']
    paths:
      - 'artikelx/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process_articles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Cache Node Modules
        uses: actions/cache@v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 24

      - name: Install Node dependencies
        run: npm ci

      - name: Setup Perl
        uses: shogo82148/actions-setup-perl@v1.37.0
        with:
          perl-version: '5.38'
          enable-modules-cache: false

      - name: Localize Assets
        run: |
          set -euo pipefail
          if [[ -f ext/gantifontshighlight.pl ]]; then
            chmod +x ext/gantifontshighlight.pl
            perl ext/gantifontshighlight.pl --quiet --no-backup
          fi

      - name: ðŸ§¹ Sterilize Schema (Node.js)
        run: node ext/clean-schema.js artikelx/

      - name: Replace Content (Perl)
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in artikelx/*.html; do
            echo "Processing $file"                      
            perl -i -wpe '
              s|https://dalam[.]web[.]id/assets/apple-touch-icon[.]png|https://dalam.web.id/ext/icons/apple-touch-icon.png|g;
              s|https://dalam[.]web[.]id/apple-touch-icon[.]png|https://dalam.web.id/ext/icons/apple-touch-icon.png|g;                          
              s|&copy;|ðŸ„¯|g;
              s|Font Awesome 6 Free|Font Awesome 7 Free|g;
              s|Â©|ðŸ„¯|g;
              s| - Layar Kosong||g;
            ' "$file"
          done     

      # Menjalankan Mirroring & WebP Optimization di folder artikelx
      - name: Inject SEO, Mirror Images & WebP (seo-fixer.js)
        run: |
          set -euo pipefail
          npm run ci-fix-meta-image

      - name: Add HTML Elements (Sed)
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in artikelx/*.html; do
            if ! grep -q 'marquee-url.css' "$file"; then
              sed -i '/<\/head>/i <link rel="stylesheet" href="/ext/marquee-url.css"><link rel="alternate" type="application/rss+xml" title="30 artikel baru bikin." href="https://dalam.web.id/rss.xml">' "$file"
            fi      
            if ! grep -q 'id="iposbrowser"' "$file"; then
              sed -i '/<\/h1>/a <div id="iposbrowser"></div>' "$file"
            fi      
            if ! grep -q 'class="search-floating-container"' "$file"; then
              sed -i '/<\/body>/i <div id="progress"></div><a id="layar-kosong-header" href="https://dalam.web.id/"></a><div class="search-floating-container"><input type="text" id="floatingSearchInput" placeholder="cari artikel..." autocomplete="off"><span id="floatingSearchClear" class="clear-button"></span><div id="floatingSearchResults" class="floating-results-container"></div></div><div id="dynamic-nav-container" class="floating-nav"></div><div id="internal-nav"></div>' "$file"
            fi      
            if ! grep -q 'id="related-marquee-section"' "$file"; then
              sed -i '/<\/body>/i <section id="related-marquee-section"><div id="related-marquee-container"></div></section><script defer src="/ext/marquee-url.js"></script>' "$file"
            fi
            if ! grep -q '/ext/iposbrowser.js' "$file"; then
              sed -i '/<\/body>/i <script defer src="/ext/iposbrowser.js"></script><script defer src="/ext/markdown.js"></script><script defer src="/ext/pesbukdiskus.js"></script>' "$file"
            fi     
          done

      - name: Move to artikel/
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(artikelx/*.html)
          if [[ ${#files[@]} -gt 0 ]]; then
            mv -f "${files[@]}" artikel/
            echo "Berhasil pindahkan ${#files[@]} file ke artikel/"
          else
            echo "Tidak ada file di artikelx/"
          fi

      - name: Commit & Push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          
          # PERBAIKAN: img/ ditambahkan agar gambar hasil mirroring ikut ter-upload
          git add .
          
          if git diff --staged --quiet; then
            echo "Tidak ada perubahan."
            exit 0
          fi

          git commit -m "Proses ArtikelX: Move, Mirror & WebP [skip ci]"
          git push origin main
