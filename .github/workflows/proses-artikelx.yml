name: üîÑ Proses ArtikelX

on:
  push:
    branches: ['main']
    paths:
      - 'artikelx/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process_articles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: üõ†Ô∏è Ganti ke Rumah aja, fontaws dan highlight.js (Bun Mode)
        run: |
          set -euo pipefail
          if [[ -f dapur/gantifontshighlight.pl ]]; then
            chmod +x dapur/gantifontshighlight.pl
            perl dapur/gantifontshighlight.pl --quiet --no-backup
          fi
          
      - name: üõ†Ô∏è Replace Content (Perl, SAFE)
        run: |
          shopt -s nullglob
          for file in artikelx/*.html; do
          echo "Processing $file"

          perl -0777 -i -pe '
            # URL icon
            s#https://dalam\[.\]web\[.\]id/assets/apple-touch-icon\.png#https://dalam.web.id/ext/icons/apple-touch-icon.png#g;
            s#https://dalam\[.\]web\[.\]id/apple-touch-icon\.png#https://dalam.web.id/ext/icons/apple-touch-icon.png#g;

            # copyright symbol
            s/&copy;/üÑØ/g;
            s/¬©/üÑØ/g;

            # Font Awesome version
            s/Font Awesome 5 Free/Font Awesome 7 Free/g;
            s/Font Awesome 6 Free/Font Awesome 7 Free/g;

            # branding title
            s/ - Layar Kosong//g;

            # hapus anchor branding (pisah, tidak digabung)
            s#<a[^>]*>\s*Dalam Web\s*</a>##g;
            s#<a[^>]*>\s*Jaga Data Pribadi Tetap Aman\s*</a>##g;

            # ganti teks anchor dalam.web.id -> Jaga Data Pribadi Tetap Aman
            s#(<a[^>]*>)\s*dalam\.web\.id\s*(</a>)#$1Jaga Data Pribadi Tetap Aman$2#g;
            s/Dalam Web Artikel/Jaga Data Pribadi Tetap Aman/g;
            
            s#\b dalam.web.id # Jaga Data Pribadi Tetap Aman #g;
            s#\b Dalam.web.id # Jaga Data Pribadi Tetap Aman #g;            

            # SEO fluff (dipisah)
            s/Analisis mendalam //g;
            s/Analisis tajam //g;
            s/Artikel mendalam //g;
            s/Panduan lengkap //g;
            s/Panduan mendalam //g;
            s/Penjelasan lengkap //g;
            s/Penjelasan mendalam //g;
            s/Simak ulasan mendalam //g;
            s/content=\"Analisis kritis /content=\"/g;
            s/content=\"Mengapa /content=\"/g;
            s/content=\"Pelajari /content=\"/g;
            s/content=\"Simak /content=\"/g;
            s/content=\"Temukan /content=\"/g;

            # Font Awesome class mapping (dipisah)
            s/fas fa-copyright/fa-brands fa-creative-commons-zero/g;
            s/\bfab /fa-brands /g;
            s/\bfar /fa-regular /g;
            s/\bfas /fa-solid /g;
          ' "$file"
          done

      - name: '2. Setup Bun.js'
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest     

      - name: Install Node dependencies
        run: bun install      

      - name: üßπ Sterilize Schema (Node.js)
        run: bun run dapur/clean-schema.ts artikelx/      

      # Menjalankan Mirroring & WebP Optimization di folder artikelx
      - name: Inject SEO, Mirror Images & WebP (seo-fixer.js)
        run: |
          set -euo pipefail
          bun run dapur/seo-fixer.ts artikelx/

      - name: Add HTML Elements (Sed)
        run: |
          set -euo pipefail
          shopt -s nullglob
          for file in artikelx/*.html; do
            # 1. CSS & RSS di Head
            if ! grep -q 'marquee-url.css' "$file"; then
              sed -i '/<\/head>/i <link rel="stylesheet" href="/ext/marquee-url.css"><link rel="alternate" type="application/rss+xml" title="30 artikel baru bikin." href="https://dalam.web.id/rss.xml">' "$file"
            fi      
            
            # 2. IPosBrowser Container setelah H1
            if ! grep -q 'id="iposbrowser"' "$file"; then
              sed -i '/<\/h1>/a <div id="iposbrowser"></div>' "$file"
            fi      
            
            # 3. Gabungkan semua elemen Body agar urutan script TIDAK TERBALIK
            # Kita cek salah satu penanda unik, misal 'search-floating-container'
            if ! grep -q 'class="search-floating-container"' "$file"; then
              # Kita susun string raksasa dengan urutan yang BENAR
              # Urutan: Progress -> Header -> Search -> Section Marquee -> SCRIPTS
              ELEMENTS='<div id="progress"></div><a id="layar-kosong-header" href="https://dalam.web.id/"></a><div class="search-floating-container"><input type="text" id="floatingSearchInput" placeholder="cari artikel..." autocomplete="off"><span id="floatingSearchClear" class="clear-button"></span><div id="floatingSearchResults" class="floating-results-container"></div></div><div id="dynamic-nav-container" class="floating-nav"></div><div id="internal-nav"></div>'
              SECTION='<section id="related-marquee-section"><div id="related-marquee-container"></div></section>'
              
              # URUTAN SCRIPT: Markdown -> IPos -> Marquee -> Pesbuk
              SCRIPTS='<script defer src="/ext/markdown.js"></script><script defer src="/ext/marquee-url.js"></script><script defer src="/ext/lightbox.js"></script><script defer src="/ext/iposbrowser.js"></script><script defer src="/ext/response.js"></script>'
              
              # Masukkan semuanya sekaligus sebelum </body>
              sed -i "/<\/body>/i $ELEMENTS$SECTION$SCRIPTS" "$file"
            fi      
          done
    
      - name: Move to artikel/
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(artikelx/*.html)
          if [[ ${#files[@]} -gt 0 ]]; then
            mv -f "${files[@]}" artikel/
            echo "Berhasil pindahkan ${#files[@]} file ke artikel/"
          else
            echo "Tidak ada file di artikelx/"
          fi

      - name: Commit & Push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          
          # PERBAIKAN: img/ ditambahkan agar gambar hasil mirroring ikut ter-upload
          git add .
          
          if git diff --staged --quiet; then
            echo "Tidak ada perubahan."
            exit 0
          fi

          git commit -m "Proses ArtikelX: Move, Mirror & WebP"
          git push origin main
