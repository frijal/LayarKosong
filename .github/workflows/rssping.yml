name: ü§ñ Ping Feeds, Sitemap, & Generate LLMs.txt

on:
  workflow_dispatch:
  schedule:
    # 07:00 UTC ‚âà 14:00 WITA
    - cron: "0 7 * * *"

permissions:
  contents: write

jobs:
  # =========================================================
  # 1Ô∏è‚É£ Deteksi URL baru dari sitemap.txt
  # =========================================================
  detect_urls:
    runs-on: ubuntu-latest
    outputs:
      has_new_urls: ${{ steps.diff.outputs.changed }}

    steps:
      - uses: actions/checkout@v4

      - name: üîç Compare sitemap vs IndexNow cache
        id: diff
        run: |
          mkdir -p mini
          touch mini/indexnow-cache.txt

          sort sitemap.txt > /tmp/sitemap.sorted
          sort mini/indexnow-cache.txt > /tmp/cache.sorted

          comm -23 /tmp/sitemap.sorted /tmp/cache.sorted > /tmp/new-urls.txt

          if [ -s /tmp/new-urls.txt ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            wc -l /tmp/new-urls.txt
            echo "üÜï URL baru terdeteksi"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Tidak ada URL baru"
          fi

          mkdir -p mini/indexnow-batch
          split -l 10000 /tmp/new-urls.txt mini/indexnow-batch/urls-

  # =========================================================
  # 2Ô∏è‚É£ Submit IndexNow (HANYA jika ada URL baru)
  # =========================================================
  indexnow:
    needs: detect_urls
    if: needs.detect_urls.outputs.has_new_urls == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: üöÄ Submit IndexNow batches
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          for file in mini/indexnow-batch/urls-*; do
            jq -n \
              --arg host "dalam.web.id" \
              --arg key "$INDEXNOW_KEY" \
              --argjson urls "$(jq -R . < "$file" | jq -s .)" \
              '{host: $host, key: $key, urlList: $urls}' \
              > payload.json

            curl -X POST "https://bing.com/indexnow" \
              -H "Content-Type: application/json; charset=utf-8" \
              --data-binary @payload.json --fail
          done

      - name: üíæ Update IndexNow cache
        run: |
          shopt -s nullglob
          FILES=(mini/indexnow-batch/urls-*)
          if [ ${#FILES[@]} -eq 0 ]; then
          echo "‚ÑπÔ∏è Tidak ada batch URL baru untuk ditambahkan ke cache"
          exit 0
          fi
          cat "${FILES[@]}" >> mini/indexnow-cache.txt
          sort -u mini/indexnow-cache.txt -o mini/indexnow-cache.txt
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add mini/indexnow-cache.txt
          git commit -m "seo: update IndexNow URL cache"
          git pull origin main --rebase
          git push

  # =========================================================
  # 3Ô∏è‚É£ Generate LLMs (maintenance only)
  # =========================================================
  generate_llms:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ‚öôÔ∏è Generate LLMs index
        run: python ext/generate_llms.py

      - name: üíæ Commit LLMs (if changed)
        run: |
          git add llms.txt llms.md llms-index.html
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è LLMs tidak berubah"
          else
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git commit -m "docs: auto-generate llms index"
            git push
          fi
