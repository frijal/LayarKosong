name: ü§ñ Ping Feeds, Sitemap, & Generate LLMs.txt

on:
  workflow_dispatch:
  schedule:
    # 07:00 UTC ‚âà 14:00 WITA
    - cron: "0 7 * * *"

permissions:
  contents: write

jobs:
  seo_and_maintenance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Cache Node Modules
        uses: actions/cache@v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # =========================================================
      # 1Ô∏è‚É£ Deteksi & Submit URL Baru (Logika Diff Sederhana)
      # =========================================================
      - name: üîç IndexNow Sync
        id: indexnow_sync
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          # Pastikan folder dan file cache ada (antisipasi file belum dibuat)
          touch mini/indexnow-cache.txt
          
          # Ambil URL yang ada di sitemap tapi BELUM ada di cache
          # Menggunakan grep -v -F -f untuk membandingkan baris per baris secara mentah
          grep -v -F -x -f mini/indexnow-cache.txt sitemap.txt > /tmp/new_urls.txt || true

          if [ -s /tmp/new_urls.txt ]; then
            echo "üÜï Menemukan URL baru untuk disubmit..."
            
            # Buat payload JSON (Bing/IndexNow limit 10k URL per request, 
            # asumsikan sitemap Bang Frijal masih di bawah itu agar simpel)
            jq -n \
              --arg host "dalam.web.id" \
              --arg key "$INDEXNOW_KEY" \
              --argjson urls "$(jq -R . < /tmp/new_urls.txt | jq -s .)" \
              '{host: $host, key: $key, urlList: $urls}' > /tmp/payload.json

            # Kirim ke Bing
            curl -X POST "https://bing.com/indexnow" \
              -H "Content-Type: application/json; charset=utf-8" \
              --data-binary @/tmp/payload.json --fail
            
            # Tambahkan yang baru saja disubmit ke dalam cache
            cat /tmp/new_urls.txt >> mini/indexnow-cache.txt
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è Tidak ada URL baru sejak submit terakhir."
            echo "sync_needed=false" >> $GITHUB_OUTPUT
          fi

      # =========================================================
      # 2Ô∏è‚É£ Generate LLMs
      # =========================================================
      - uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.x'

      - name: ‚öôÔ∏è Generate LLMs index
        run: |
          if [ -f ext/generate_llms.py ]; then
            python3 ext/generate_llms.py
          fi

      # =========================================================
      # 3Ô∏è‚É£ Simpan Catatan (Commit)
      # =========================================================
      - name: üíæ Save Changes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add cache dan hasil generate LLM
          git add mini/indexnow-cache.txt llms.txt llms.md llms-index.html
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Tidak ada perubahan data."
          else
            git commit -m "chore: update indexnow cache & llms"
            git pull origin main --rebase
            git push
          fi
