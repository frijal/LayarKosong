name: Update Categories with Gemini AI

on:
  workflow_dispatch: # 100% Manual dari tab Actions

jobs:
  classify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: true
      
      - name: Cache Node Modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24

      - name: Process Categories
        env:
          # Mengambil semua 12 secret API Key (0-11)
          GEMINI_KEYS: ${{ secrets.GEMINI_API_KEY }},${{ secrets.GEMINI_API_KEY2 }},${{ secrets.GEMINI_API_KEY3 }},${{ secrets.GEMINI_API_KEY4 }},${{ secrets.GEMINI_API_KEY5 }},${{ secrets.GEMINI_API_KEY6 }},${{ secrets.GEMINI_API_KEY7 }},${{ secrets.GEMINI_API_KEY8 }},${{ secrets.GEMINI_API_KEY9 }},${{ secrets.GEMINI_API_KEY10 }},${{ secrets.GEMINI_API_KEY11 }}
        run: node ext/kategoriAI.js

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update titleToCategory.js via Gemini AI"
          branch: manual-ai-classification
          delete-branch: true
          title: "ðŸ¤– [MANUAL] Update Kategori via Gemini AI"
          body: |
            Workflow ini dijalankan secara manual melalui dispatch.
            AI telah memindai `artikel.json` dan menyusun kata kunci baru.
            Silakan tinjau perubahan di `ext/titleToCategory.js`.
          labels: |
            manual-trigger
            ai-processed
