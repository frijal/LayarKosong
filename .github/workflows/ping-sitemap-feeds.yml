name: ğŸŒ Smart Ping Feeds & Sitemap (Modern SEO Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # otomatis setiap hari jam 06:00 UTC (13:00 WIB)

jobs:
  smart-ping:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ping only recently updated XMLs
        run: |
          DOMAIN="https://frijal.pages.dev"
          INDEXNOW_KEY="f8399d60e90d46a6945577b73ff3f778"

          echo "ğŸ” Mendeteksi file XML yang diubah dalam 24 jam terakhir..."
          RECENT_FILES=$(find . -maxdepth 1 -type f \( -name "feed-*.xml" -o -name "rss.xml" -o -name "sitemap.xml" \) -mtime -1)

          if [ -z "$RECENT_FILES" ]; then
            echo "âœ… Tidak ada feed/sitemap yang diubah dalam 24 jam terakhir. Ping dibatalkan."
            exit 0
          fi

          echo "ğŸ“‚ File yang akan diping:"
          echo "$RECENT_FILES"
          echo "============================================"

          for FILE in $RECENT_FILES; do
            URL="${DOMAIN}/${FILE#./}"
            echo "ğŸ”” Mem-ping: $URL"

            # ğŸŒ Ping-o-matic (multi aggregator)
            curl -s "https://pingomatic.com/ping/?title=Frijal+Feed&blogurl=${URL}&rssurl=${URL}" || true

            # ğŸ”¥ FeedBurner
            curl -s "https://feedburner.google.com/fb/a/pingSubmit?bloglink=${URL}" || true

            # ğŸ”— Twingly
            curl -s -d "url=${URL}" https://rpc.twingly.com/ || true

            # ğŸ“° Weblogs.com
            curl -s -d "name=Frijal&url=${URL}" http://rpc.weblogs.com/RPC2 || true

            # âš¡ IndexNow (Bing, Yandex, Naver, Seznam)
            curl -s "https://api.indexnow.org/indexnow?url=${URL}&key=${INDEXNOW_KEY}" || true

            # ğŸ” Bing Webmaster Ping
            curl -s "https://www.bing.com/ping?sitemap=${URL}" || true

            echo "âœ… Ping sukses dikirim: $URL"
            echo "---------------------------------------------"

            # jeda 5 detik agar aman dari rate-limit
            sleep 5
          done

          echo "ğŸ‰ Semua file terbaru berhasil diping ke layanan modern!"
