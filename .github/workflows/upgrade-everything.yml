name: ğŸ› ï¸ Pemeliharaan Dependensi (Ultra-Optimal v5 + Integrity Alert System)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 9 * *' # setiap tanggal 9 pukul 01:00 UTC (08:00 WIB)

jobs:
  maintenance-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ§© Checkout kode
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ğŸ’¾ Cache NPM
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-

      - name: ğŸ“¦ Install dependencies
        run: npm ci || npm install

      - name: ğŸ”¼ Upgrade dependencies
        run: |
          npm install -g npm-check-updates
          ncu -u --target minor
          echo "âœ… Dependencies diupgrade."

      - name: ğŸ§¹ Cleanup opsional
        run: |
          if [ -f ext/cleanup.js ]; then
            node ext/cleanup.js
          else
            echo "âš ï¸ cleanup.js tidak ada."
          fi

      - name: ğŸ” Cek perubahan deps
        id: check_deps
        run: |
          if [[ $(git status --porcelain package.json package-lock.json) ]]; then
            echo "deps_changed=true" >> $GITHUB_OUTPUT
          else
            echo "deps_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§  Cek versi Highlight.js & Font Awesome
        id: check_assets
        run: |
          mkdir -p mini
          HLJS_LATEST=$(npm view @highlightjs/cdn-assets version)
          FA_LATEST=$(npm view @fortawesome/fontawesome-free version)
          HLJS_CURR=$(grep '^hljs=' mini/asset-info.txt 2>/dev/null | cut -d'=' -f2)
          FA_CURR=$(grep '^fontawesome=' mini/asset-info.txt 2>/dev/null | cut -d'=' -f2)
          echo "hljs_latest=$HLJS_LATEST" >> $GITHUB_OUTPUT
          echo "hljs_current=$HLJS_CURR" >> $GITHUB_OUTPUT
          echo "fa_latest=$FA_LATEST" >> $GITHUB_OUTPUT
          echo "fa_current=$FA_CURR" >> $GITHUB_OUTPUT

      - name: ğŸŒˆ Update Highlight.js & Font Awesome
        if: steps.check_deps.outputs.deps_changed == 'true' || steps.check_assets.outputs.hljs_current != steps.check_assets.outputs.hljs_latest || steps.check_assets.outputs.fa_current != steps.check_assets.outputs.fa_latest
        run: |
          npm install @highlightjs/cdn-assets@latest @fortawesome/fontawesome-free@latest --no-save
          mkdir -p ext mini
          cp node_modules/@highlightjs/cdn-assets/highlight.min.js ext/highlight.js
          cp node_modules/@highlightjs/cdn-assets/styles/github*.css ext/
          cp -r node_modules/@fortawesome/fontawesome-free/webfonts ext/fontawesome-webfonts
          cp node_modules/@fortawesome/fontawesome-free/css/all.min.css ext/fontawesome.css
          sed -i 's|\.\./webfonts/|./fontawesome-webfonts/|g' ext/fontawesome.css
          DATE_NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "hljs=${{ steps.check_assets.outputs.hljs_latest }}"
            echo "fontawesome=${{ steps.check_assets.outputs.fa_latest }}"
            echo "updated=${DATE_NOW}"
          } > mini/asset-info.txt

      - name: ğŸ” Verifikasi Font Awesome (ukuran + hash)
        id: verify_fonts
        run: |
          echo "ğŸ” Verifikasi font + hash SHA-256..."
          mkdir -p mini
          FONT_DIR="ext/fontawesome-webfonts"
          OUTPUT_FILE="mini/fontawesome-verify.txt"
          PREV_FILE="mini/fontawesome-verify-prev.txt"
          ALERT_FILE="mini/fontawesome-alert.txt"

          # Simpan salinan lama
          if [ -f "$OUTPUT_FILE" ]; then
            cp "$OUTPUT_FILE" "$PREV_FILE"
          fi

          echo "ğŸ“„ Daftar font + ukuran + hash (SHA-256):" > "$OUTPUT_FILE"
          echo "----------------------------------------" >> "$OUTPUT_FILE"

          find "$FONT_DIR" -type f \( -name "*.woff" -o -name "*.woff2" -o -name "*.ttf" \) | sort | while read -r file; do
            size=$(stat -c%s "$file")
            hash=$(sha256sum "$file" | awk '{print $1}')
            echo "$(basename "$file")|$size|$hash" >> "$OUTPUT_FILE"
          done

          echo "----------------------------------------" >> "$OUTPUT_FILE"

          # Bandingkan hash lama & baru
          if [ -f "$PREV_FILE" ]; then
            diff_output=$(diff -u "$PREV_FILE" "$OUTPUT_FILE" || true)
            if [ -n "$diff_output" ]; then
              echo "ğŸš¨ Perubahan hash/ukuran terdeteksi pada font:" > "$ALERT_FILE"
              echo "$diff_output" >> "$ALERT_FILE"
              echo "alert=true" >> $GITHUB_OUTPUT
            else
              echo "alert=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "alert=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Audit & Lint
        run: |
          npm audit --omit=dev || true
          npm run lint --if-present || true
          npm run test --if-present || true

      - name: ğŸ” Cek perubahan akhir
        id: check_changes
        run: |
          if [[ $(git status --porcelain package.json package-lock.json ext mini) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¨ Buat Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/auto-maintenance-${{ github.run_id }}
          title: 'chore: Auto Maintenance (Deps + Assets + Font Integrity)'
          commit-message: 'chore: upgrade deps, sync Highlight.js & Font Awesome, verify font hash'
          body: |
            ğŸ”§ **Pemeliharaan Otomatis v5 (Integrity Alert System)**

            Perubahan:
            - Upgrade Dependencies
            - Sinkronisasi Highlight.js & Font Awesome
            - Verifikasi ukuran + SHA-256 setiap font (.woff, .woff2, .ttf)
            - Audit & Lint

            ${{ steps.verify_fonts.outputs.alert == 'true' && 'ğŸš¨ **PERINGATAN: Deteksi perubahan hash font!** Lihat mini/fontawesome-alert.txt untuk detail.' || 'âœ… Semua font aman.' }}

            _(Generated by GitHub Actions)_
          labels: dependencies, chore, automated${{ steps.verify_fonts.outputs.alert == 'true' && ', integrity-alert' || '' }}
          reviewers: frijal
          draft: false

      - name: â„¹ï¸ Tidak ada perubahan
        if: steps.check_changes.outputs.changes_detected == 'false'
        run: echo "ğŸ’¤ Tidak ada perubahan signifikan."
