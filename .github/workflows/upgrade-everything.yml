name: ðŸ› ï¸ Pemeliharaan Dependensi (Ultra-Optimal v6 Final - Bun Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 9 * *' # Setiap tanggal 9 pukul 08:00 WIB

jobs:
  maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ§© Checkout kode
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: âš™ï¸ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: latest

      - name: ðŸ“¦ Install & Upgrade Dependencies
        run: |
          # Install awal untuk sinkronisasi
          bun install
          
          # Upgrade package.json (Minor) menggunakan bunx
          bunx npm-check-updates -u --target minor
          
          # Install ulang untuk memperbarui bun.lock
          bun install
          echo "âœ… Dependencies diupgrade dan bun.lock disinkronkan."

      - name: ðŸŒˆ Update Assets Highlight.js & Font Awesome
        run: |
          # Install paket terbaru secara temporary (Bun sangat cepat di sini)
          bun add @highlightjs/cdn-assets@latest @fortawesome/fontawesome-free@latest --no-save

          # Ambil JS & CSS Utama Highlight.js
          cp node_modules/@highlightjs/cdn-assets/highlight.min.js dapur/highlight.js
          cp node_modules/@highlightjs/cdn-assets/styles/default.min.css dapur/default.min.css

          # Mapping cerdas Highlight.js
          cp node_modules/@highlightjs/cdn-assets/styles/github*.css dapur/
          cp node_modules/@highlightjs/cdn-assets/styles/tomorrow-night-bright.css dapur/prism-tomorrow.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/monokai.min.css dapur/prism-okaidia.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/default.min.css dapur/prism.min.css
          
          # Tema populer lainnya
          cp node_modules/@highlightjs/cdn-assets/styles/atom-one-dark.min.css dapur/atom-one-dark.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/atom-one-light.min.css dapur/atom-one-light.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/monokai.min.css dapur/monokai.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/vs.min.css dapur/vs.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/vs2015.min.css dapur/vs-dark.min.css

          # Urus Font Awesome (Webfonts + CSS)
          mkdir -p dapur/fontawesome-webfonts/
          cp -f node_modules/@fortawesome/fontawesome-free/webfonts/* dapur/fontawesome-webfonts/
          cp node_modules/@fortawesome/fontawesome-free/css/all.min.css dapur/fontawesome.css

          # Patch Path CSS Font Awesome
          sed -i 's|\.\./webfonts/|./fontawesome-webfonts/|g' dapur/fontawesome.css

          # Ambil Versi untuk Metadata (Ganti node -p dengan jq yang lebih ringan)
          HLJS_VER=$(cat node_modules/@highlightjs/cdn-assets/package.json | jq -r .version)
          FA_VER=$(cat node_modules/@fortawesome/fontawesome-free/package.json | jq -r .version)

          echo -e "hljs=$HLJS_VER\nfontawesome=$FA_VER\nupdated=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > mini/asset-info.txt
          echo "âœ… All Assets updated: HLJS v$HLJS_VER, FA v$FA_VER"

      - name: ðŸ” Verifikasi Integritas Font
        id: font_check
        shell: bash
        run: |
          FONT_DIR="dapur/fontawesome-webfonts"
          OUTPUT="mini/fontawesome-verify.txt"
          PREV="mini/fontawesome-verify-prev.txt"
          
          # Backup laporan lama jika ada
          [ -f "$OUTPUT" ] && cp "$OUTPUT" "$PREV"
          
          # Header laporan (pakai printf supaya lebih aman dibanding echo emoji)
          printf "Font Integrity Report - $(date)\n" > "$OUTPUT"
          printf "Filename | Size | SHA-256\n" >> "$OUTPUT"
          
          # Gunakan find tanpa line continuation yang ribet
          # Kita simpan hasil find ke variable dulu atau pakai pipe langsung yang bersih
          find "$FONT_DIR" -type f -regex ".*\.\(woff\|woff2\|ttf\)" | sort | while read -r f; do
              fname=$(basename "$f")
              fsize=$(stat -c%s "$f")
              fhash=$(sha256sum "$f" | awk '{print $1}')
              echo "$fname | $fsize | $fhash" >> "$OUTPUT"
          done
          
          # Logika perbandingan
          if [ -f "$PREV" ]; then
            if ! diff -q "$PREV" "$OUTPUT" > /dev/null; then
              echo "ðŸš¨ Perubahan terdeteksi pada hash font!"
              echo "alert=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Tidak ada perubahan pada font."
              echo "alert=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ Laporan pertama kali dibuat."
            echo "alert=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ§ª Audit & Detective Scan
        run: |
          # Gunakan audit-ci yang lebih bersahabat dengan Bun
          bunx audit-ci --low || true
          bun run dapur/cek-mubazir.js
          bun run dapur/cleanup.js

      - name: ðŸ” Cek perubahan akhir
        id: check_changes
        run: |
          git add .
          [[ -n "$(git status --porcelain)" ]] && echo "detected=true" >> $GITHUB_OUTPUT || echo "detected=false" >> $GITHUB_OUTPUT

      - name: ðŸ“¨ Buat Pull Request
        if: steps.check_changes.outputs.detected == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8
        with:
          branch: chore/auto-maintenance
          delete-branch: true
          title: 'chore: Auto Maintenance (Deps + Assets)'
          commit-message: 'chore: automated maintenance'
          body: |
            ðŸ”§ **Pemeliharaan Otomatis Layar Kosong (Bun Engine)**
            - Upgrade Dependencies (Minor) via Bun
            - Update Assets (Highlight.js & Font Awesome)
            - ${{ steps.font_check.outputs.alert == 'true' && 'ðŸš¨ **ALERT:** Hash font berubah!' || 'âœ… Hash font aman.' }}
          labels: automated
          reviewers: frijal
