name: ğŸ› ï¸ Pemeliharaan Dependensi (Upgrade, Cleanup & Highlight.js Sync)

on:
  # 1ï¸âƒ£ Bisa dijalankan manual dari tab "Actions"
  workflow_dispatch:
  
  # 2ï¸âƒ£ Dijalankan otomatis setiap bulan, tanggal 9, jam 01:00 UTC (08:00 WIB)
  schedule:
    - cron: '0 1 9 * *'

jobs:
  maintenance-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ§© Checkout kode
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies (untuk tools)
        run: npm install

      # =============================
      # BAGIAN 1: Upgrade Dependencies
      # =============================
      - name: ğŸ”¼ Upgrade dependencies (minor & patch)
        run: |
          npm install -g npm-check-updates
          ncu -u --target minor
          echo "âœ… Upgrade selesai (minor/patch)."

      # =============================
      # BAGIAN 2: Cleanup
      # =============================
      - name: ğŸ§¹ Cleanup unused packages
        run: |
          echo "ğŸ§½ Menjalankan skrip cleanup..."
          node ext/cleanup.js || echo "âš ï¸ Tidak ada cleanup script."

      # =============================
      # BAGIAN 3: Update Highlight.js
      # =============================
      - name: ğŸŒˆ Ambil versi terbaru Highlight.js dari NPM
        run: |
          echo "ğŸ“¦ Menginstal paket @highlightjs/cdn-assets..."
          npm install @highlightjs/cdn-assets@latest --no-save

          mkdir -p ext mini
          cp node_modules/@highlightjs/cdn-assets/highlight.min.js ext/
          cp node_modules/@highlightjs/cdn-assets/styles/github.min.css ext/
          cp node_modules/@highlightjs/cdn-assets/styles/github-dark.min.css ext/

          LATEST_VER=$(node -p "require('./node_modules/@highlightjs/cdn-assets/package.json').version")
          DATE_NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "version=${LATEST_VER}" > mini/highlight-info.txt
          echo "updated=${DATE_NOW}" >> mini/highlight-info.txt
          echo "source=npm:@highlightjs/cdn-assets" >> mini/highlight-info.txt
          echo "âœ… Highlight.js versi ${LATEST_VER} tersimpan di ext/"

      # =============================
      # BAGIAN 4: Validasi File
      # =============================
      - name: ğŸ§ª Validasi hasil unduhan
        id: validate_files
        run: |
          if [[ -s ext/highlight.min.js && -s ext/github.min.css && -s ext/github-dark.min.css ]]; then
            echo "âœ… Semua file Highlight.js valid."
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ File Highlight.js tidak lengkap atau kosong."
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

      # =============================
      # BAGIAN 5: Auto-Rollback Aman
      # =============================
      - name: ğŸ”™ Rollback jika gagal
        if: steps.validate_files.outputs.ok == 'false'
        run: |
          echo "âš ï¸ Melakukan rollback ke commit terakhir..."
          git restore ext/ || echo "â„¹ï¸ Folder ext/ belum terdaftar di Git."

          if git ls-files --error-unmatch mini/highlight-info.txt > /dev/null 2>&1; then
            git restore mini/highlight-info.txt
          else
            echo "â„¹ï¸ File mini/highlight-info.txt belum ada di repo, dilewati."
          fi

          echo "âœ… Rollback selesai. Tidak ada perubahan disimpan."
          exit 1

      # =============================
      # BAGIAN 6: Cek & Commit
      # =============================
      - name: ğŸ” Cek perubahan
        id: check_changes
        run: |
          if [[ $(git status --porcelain package.json package-lock.json ext mini) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Ada perubahan yang siap di-commit."
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "ğŸ“­ Tidak ada perubahan."
          fi

      - name: ğŸ§ª Jalankan build & test (jika ada perubahan)
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          npm run build --if-present
          npm test --if-present

      # =============================
      # BAGIAN 7: Buat Pull Request
      # =============================
      - name: ğŸ“¨ Create Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/auto-maintenance-${{ github.run_id }}
          title: 'chore: Auto Maintenance (Deps + Highlight.js)'
          commit-message: 'chore: Upgrade deps, cleanup, dan sinkronisasi Highlight.js'
          body: |
            PR otomatis ini mencakup:
            1ï¸âƒ£ **Upgrade Dependencies (minor/patch)** via `npm-check-updates`
            2ï¸âƒ£ **Cleanup Packages** dengan `ext/cleanup.js`
            3ï¸âƒ£ **Sinkronisasi Highlight.js** dari `@highlightjs/cdn-assets`
            4ï¸âƒ£ Otomatis rollback jika validasi file gagal

            ğŸ• Dibuat: ${{ github.event.repository.updated_at }}
          labels: dependencies, chore, automated pr
          reviewers: frijal
          draft: false
