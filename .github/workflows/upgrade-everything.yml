name: ğŸ› ï¸ Pemeliharaan & Update Highlight.js (Hybrid + Auto-Rollback)

on:
  # Bisa dijalankan manual dari tab "Actions"
  workflow_dispatch:

  # Dijalankan otomatis setiap bulan tanggal 9 jam 1 UTC
  schedule:
    - cron: '0 1 9 * *'

jobs:
  maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # ---------------------------------------------------------
      # BAGIAN 1: Pemeliharaan umum (Upgrade & Cleanup)
      # ---------------------------------------------------------
      - name: ğŸ“¦ Install dependencies untuk tools
        run: npm install

      - name: ğŸ†™ Upgrade dependencies (minor & patch)
        run: |
          npm install -g npm-check-updates
          ncu -u --target minor
          echo "âœ… Dependensi minor/patch diperbarui."

      - name: ğŸ§¹ Cleanup paket tidak terpakai
        run: |
          echo "ğŸ§¹ Membersihkan paket yang tidak digunakan..."
          node ext/cleanup.js || echo "â„¹ï¸ Tidak ada cleanup.js ditemukan, dilewati."

      # ---------------------------------------------------------
      # BAGIAN 2: Update Highlight.js via NPM resmi
      # ---------------------------------------------------------
      - name: ğŸ“¦ Install paket Highlight.js CDN Assets
        run: |
          npm install @highlightjs/cdn-assets@latest --save-dev
          mkdir -p ext mini

      - name: ğŸ“ Salin file penting ke folder publik
        run: |
          echo "ğŸ“ Menyalin hasil NPM ke folder publik ext/"
          cp node_modules/@highlightjs/cdn-assets/highlight.min.js ext/
          cp node_modules/@highlightjs/cdn-assets/styles/github.min.css ext/
          cp node_modules/@highlightjs/cdn-assets/styles/github-dark.min.css ext/
          echo "âœ… Penyalinan selesai."

      - name: ğŸ§¾ Catat versi Highlight.js
        run: |
          HL_VERSION=$(npm list @highlightjs/cdn-assets | grep @highlightjs | awk -F@ '{print $3}')
          DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "ğŸ“„ Versi Highlight.js: $HL_VERSION"
          echo "Highlight.js Version: $HL_VERSION" > mini/highlight-info.txt
          echo "Updated on: $DATE" >> mini/highlight-info.txt

      # ---------------------------------------------------------
      # BAGIAN 3: Validasi & Auto-Rollback
      # ---------------------------------------------------------
      - name: ğŸ” Validasi file hasil update
        id: validate_files
        run: |
          if [[ -s ext/highlight.js && -s ext/github.min.css && -s ext/github-dark.min.css ]]; then
            echo "âœ… Semua file Highlight.js valid."
            echo "ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ File Highlight.js tidak lengkap atau kosong."
            echo "ok=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”™ Rollback jika gagal
        if: steps.validate_files.outputs.ok == 'false'
        run: |
          echo "âš ï¸ Melakukan rollback ke commit terakhir..."
          git restore ext/
          git restore mini/highlight-info.txt
          echo "âœ… Rollback selesai. Tidak ada perubahan disimpan."
          exit 1

      # ---------------------------------------------------------
      # BAGIAN 4: Commit & Pull Request otomatis
      # ---------------------------------------------------------
      - name: ğŸ§  Cek apakah ada perubahan
        id: check_changes
        run: |
          if [[ $(git status --porcelain ext mini package.json package-lock.json) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Jalankan build & test (jika ada perubahan)
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          npm run build --if-present
          npm test --if-present

      - name: ğŸ” Buat Pull Request otomatis
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/monthly-maintenance-${{ github.run_id }}
          title: 'chore: Monthly Maintenance & Highlight.js Update'
          commit-message: 'chore: Monthly maintenance, deps upgrade, and Highlight.js refresh'
          body: |
            ğŸ”„ **Pembaruan Bulanan Otomatis**
            
            - Upgrade dependensi minor/patch
            - Cleanup paket tidak terpakai
            - Update Highlight.js (`@highlightjs/cdn-assets@latest`)
            - Catatan versi tersimpan di `mini/highlight-info.txt`

            âœ… Build & validasi berhasil â€” siap direview.
          labels: maintenance, dependencies, automated
          reviewers: frijal
          draft: false
