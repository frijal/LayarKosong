name: ğŸ› ï¸ Pemeliharaan Dependensi (Super-Optimal)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 9 * *'

jobs:
  maintenance-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ§© Checkout kode
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm install

      # Upgrade dependencies
      - name: ğŸ”¼ Upgrade dependencies (minor & patch)
        run: |
          npm install -g npm-check-updates
          ncu -u --target minor
          echo "âœ… Upgrade dependencies selesai."

      # Cleanup
      - name: ğŸ§¹ Cleanup unused packages
        run: |
          if [ -f ext/cleanup.js ]; then
            node ext/cleanup.js
          else
            echo "âš ï¸ File cleanup.js tidak ditemukan, dilewati."
          fi

      # Cek perubahan dependencies
      - name: ğŸ” Cek perubahan dependencies
        id: check_deps
        run: |
          if [[ $(git status --porcelain package.json package-lock.json) ]]; then
            echo "deps_changed=true" >> $GITHUB_OUTPUT
          else
            echo "deps_changed=false" >> $GITHUB_OUTPUT
          fi

      # Cek versi Highlight.js terbaru
      - name: ğŸŒˆ Cek versi Highlight.js
        id: check_hljs_version
        run: |
          LATEST_VER=$(npm view @highlightjs/cdn-assets version)
          if [ -f mini/highlight-info.txt ]; then
            CURRENT_VER=$(grep '^version=' mini/highlight-info.txt | cut -d'=' -f2)
          else
            CURRENT_VER=""
          fi
          echo "Versi saat ini: $CURRENT_VER, Versi terbaru: $LATEST_VER"
          if [ "$CURRENT_VER" = "$LATEST_VER" ]; then
            echo "hljs_up_to_date=true" >> $GITHUB_OUTPUT
          else
            echo "hljs_up_to_date=false" >> $GITHUB_OUTPUT
          fi

      # Update Highlight.js hanya jika perlu dan jika deps berubah
      - name: ğŸŒˆ Update Highlight.js jika perlu
        if: steps.check_deps.outputs.deps_changed == 'true' || steps.check_hljs_version.outputs.hljs_up_to_date == 'false'
        run: |
          echo "ğŸ“¦ Menginstal @highlightjs/cdn-assets terbaru..."
          npm install @highlightjs/cdn-assets@latest --no-save
          mkdir -p ext mini
          cp node_modules/@highlightjs/cdn-assets/highlight.min.js ext/highlight.js
          cp node_modules/@highlightjs/cdn-assets/styles/github.min.css ext/github.min.css
          cp node_modules/@highlightjs/cdn-assets/styles/github-dark.min.css ext/github-dark.min.css
          DATE_NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "version=$(node -p "require('./node_modules/@highlightjs/cdn-assets/package.json').version")"
            echo "updated=${DATE_NOW}"
            echo "source=npm:@highlightjs/cdn-assets"
          } > mini/highlight-info.txt
          echo "âœ… Highlight.js diperbarui jika ada versi baru atau deps berubah."

      # Cek perubahan semua (deps + Highlight.js)
      - name: ğŸ” Cek perubahan akhir
        id: check_changes
        run: |
          if [[ $(git status --porcelain package.json package-lock.json ext mini) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      # Build & Test jika ada perubahan
      - name: ğŸ§ª Build & Test
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          npm run build --if-present
          npm test --if-present

      # Buat Pull Request jika ada perubahan
      - name: ğŸ“¨ Create Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/auto-maintenance-${{ github.run_id }}
          title: 'chore: Auto Maintenance (Deps + Highlight.js)'
          commit-message: 'chore: Upgrade deps, cleanup, dan sinkronisasi Highlight.js'
          body: |
            PR otomatis ini mencakup:
            - Upgrade Dependencies (minor/patch)
            - Cleanup Packages
            - Sinkronisasi Highlight.js (hanya jika versi baru atau deps berubah)
          labels: dependencies, chore, automated pr
          reviewers: frijal
          draft: false
